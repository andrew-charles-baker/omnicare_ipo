<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Research Team">
<meta name="dcterms.date" content="2025-12-23">

<title>Validating the Fact-Intensity Measure</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="02_measure_validation_files/libs/clipboard/clipboard.min.js"></script>
<script src="02_measure_validation_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="02_measure_validation_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="02_measure_validation_files/libs/quarto-html/popper.min.js"></script>
<script src="02_measure_validation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02_measure_validation_files/libs/quarto-html/anchor.min.js"></script>
<link href="02_measure_validation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02_measure_validation_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02_measure_validation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02_measure_validation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02_measure_validation_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression">1. Linear Regression</a>
  <ul class="collapse">
  <li><a href="#full-sample" id="toc-full-sample" class="nav-link" data-scroll-target="#full-sample">Full Sample</a></li>
  <li><a href="#pre-omnicare" id="toc-pre-omnicare" class="nav-link" data-scroll-target="#pre-omnicare">Pre-Omnicare</a></li>
  <li><a href="#post-omnicare" id="toc-post-omnicare" class="nav-link" data-scroll-target="#post-omnicare">Post-Omnicare</a></li>
  <li><a href="#summary-table" id="toc-summary-table" class="nav-link" data-scroll-target="#summary-table">Summary Table</a></li>
  </ul></li>
  <li><a href="#binscatter-optimal-binning" id="toc-binscatter-optimal-binning" class="nav-link" data-scroll-target="#binscatter-optimal-binning">2. Binscatter (Optimal Binning)</a>
  <ul class="collapse">
  <li><a href="#full-sample-1" id="toc-full-sample-1" class="nav-link" data-scroll-target="#full-sample-1">Full Sample</a></li>
  <li><a href="#pre-omnicare-1" id="toc-pre-omnicare-1" class="nav-link" data-scroll-target="#pre-omnicare-1">Pre-Omnicare</a></li>
  <li><a href="#post-omnicare-1" id="toc-post-omnicare-1" class="nav-link" data-scroll-target="#post-omnicare-1">Post-Omnicare</a></li>
  <li><a href="#combined-panel" id="toc-combined-panel" class="nav-link" data-scroll-target="#combined-panel">Combined Panel</a></li>
  </ul></li>
  <li><a href="#distribution-regression" id="toc-distribution-regression" class="nav-link" data-scroll-target="#distribution-regression">3. Distribution Regression</a>
  <ul class="collapse">
  <li><a href="#full-sample-2" id="toc-full-sample-2" class="nav-link" data-scroll-target="#full-sample-2">Full Sample</a></li>
  <li><a href="#pre-omnicare-2" id="toc-pre-omnicare-2" class="nav-link" data-scroll-target="#pre-omnicare-2">Pre-Omnicare</a></li>
  <li><a href="#post-omnicare-2" id="toc-post-omnicare-2" class="nav-link" data-scroll-target="#post-omnicare-2">Post-Omnicare</a></li>
  <li><a href="#combined-comparison" id="toc-combined-comparison" class="nav-link" data-scroll-target="#combined-comparison">Combined Comparison</a></li>
  </ul></li>
  <li><a href="#summary-and-interpretation" id="toc-summary-and-interpretation" class="nav-link" data-scroll-target="#summary-and-interpretation">4. Summary and Interpretation</a></li>
  <li><a href="#technical-notes" id="toc-technical-notes" class="nav-link" data-scroll-target="#technical-notes">Technical Notes</a>
  <ul class="collapse">
  <li><a href="#binscatter-method" id="toc-binscatter-method" class="nav-link" data-scroll-target="#binscatter-method">Binscatter Method</a></li>
  <li><a href="#distribution-regression-1" id="toc-distribution-regression-1" class="nav-link" data-scroll-target="#distribution-regression-1">Distribution Regression</a></li>
  </ul></li>
  <li><a href="#covariate-controlled-analysis" id="toc-covariate-controlled-analysis" class="nav-link" data-scroll-target="#covariate-controlled-analysis">5. Covariate-Controlled Analysis</a>
  <ul class="collapse">
  <li><a href="#ols-with-controls" id="toc-ols-with-controls" class="nav-link" data-scroll-target="#ols-with-controls">5.1 OLS with Controls</a></li>
  <li><a href="#comparison-baseline-vs.-controlled" id="toc-comparison-baseline-vs.-controlled" class="nav-link" data-scroll-target="#comparison-baseline-vs.-controlled">Comparison: Baseline vs.&nbsp;Controlled</a></li>
  <li><a href="#control-variable-effects" id="toc-control-variable-effects" class="nav-link" data-scroll-target="#control-variable-effects">Control Variable Effects</a></li>
  <li><a href="#binscatter-with-controls" id="toc-binscatter-with-controls" class="nav-link" data-scroll-target="#binscatter-with-controls">5.2 Binscatter with Controls</a></li>
  <li><a href="#binscatter-by-period-with-controls" id="toc-binscatter-by-period-with-controls" class="nav-link" data-scroll-target="#binscatter-by-period-with-controls">Binscatter by Period (with Controls)</a></li>
  <li><a href="#distribution-regression-with-controls" id="toc-distribution-regression-with-controls" class="nav-link" data-scroll-target="#distribution-regression-with-controls">5.3 Distribution Regression with Controls</a></li>
  <li><a href="#full-sample-with-controls" id="toc-full-sample-with-controls" class="nav-link" data-scroll-target="#full-sample-with-controls">Full Sample with Controls</a></li>
  <li><a href="#comparison-baseline-vs.-controlled-distribution-regression" id="toc-comparison-baseline-vs.-controlled-distribution-regression" class="nav-link" data-scroll-target="#comparison-baseline-vs.-controlled-distribution-regression">Comparison: Baseline vs.&nbsp;Controlled Distribution Regression</a></li>
  <li><a href="#pre-vs.-post-omnicare-with-controls" id="toc-pre-vs.-post-omnicare-with-controls" class="nav-link" data-scroll-target="#pre-vs.-post-omnicare-with-controls">Pre vs.&nbsp;Post-Omnicare with Controls</a></li>
  <li><a href="#summary-of-covariate-analysis" id="toc-summary-of-covariate-analysis" class="nav-link" data-scroll-target="#summary-of-covariate-analysis">5.4 Summary of Covariate Analysis</a></li>
  </ul></li>
  <li><a href="#cfm-distributional-decomposition" id="toc-cfm-distributional-decomposition" class="nav-link" data-scroll-target="#cfm-distributional-decomposition">6. CFM Distributional Decomposition</a>
  <ul class="collapse">
  <li><a href="#notation-and-setup" id="toc-notation-and-setup" class="nav-link" data-scroll-target="#notation-and-setup">Notation and Setup</a></li>
  <li><a href="#raw-distributional-shifts-pre-vs.-post-omnicare" id="toc-raw-distributional-shifts-pre-vs.-post-omnicare" class="nav-link" data-scroll-target="#raw-distributional-shifts-pre-vs.-post-omnicare">Raw Distributional Shifts: Pre vs.&nbsp;Post Omnicare</a></li>
  <li><a href="#run-the-decomposition" id="toc-run-the-decomposition" class="nav-link" data-scroll-target="#run-the-decomposition">Run the Decomposition</a></li>
  <li><a href="#plot-all-four-distributions" id="toc-plot-all-four-distributions" class="nav-link" data-scroll-target="#plot-all-four-distributions">Plot: All Four Distributions</a></li>
  <li><a href="#plot-decomposition-effects" id="toc-plot-decomposition-effects" class="nav-link" data-scroll-target="#plot-decomposition-effects">Plot: Decomposition Effects</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">Interpretation</a></li>
  <li><a href="#technical-notes-on-cfm-decomposition" id="toc-technical-notes-on-cfm-decomposition" class="nav-link" data-scroll-target="#technical-notes-on-cfm-decomposition">Technical Notes on CFM Decomposition</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Validating the Fact-Intensity Measure</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Research Team </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 23, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This document validates the BERT-based fact-intensity measure (<code>rf_fact_t07</code>) by examining its relationship with first-day IPO returns. The hypothesis is:</p>
<blockquote class="blockquote">
<p><strong>Higher fact-intensity in S-1 risk factor disclosures should be associated with lower first-day returns</strong> (less underpricing).</p>
</blockquote>
<p>The intuition is that more factual disclosure reduces information asymmetry between issuers and investors, leading to more accurate pricing and smaller first-day “pops.”</p>
<p>We examine this relationship using three approaches:</p>
<ol type="1">
<li><strong>Linear Regression</strong>: OLS of first-day return on fact-intensity</li>
<li><strong>Binscatter</strong>: Non-parametric visualization using optimal binning (Cattaneo et al.)</li>
<li><strong>Distribution Regression</strong>: Series of binary regressions at different return thresholds</li>
</ol>
<p>Each analysis is conducted for:</p>
<ul>
<li>Full sample</li>
<li>Pre-Omnicare (before March 24, 2015)</li>
<li>Post-Omnicare (March 24, 2015 and after)</li>
</ul>
<p><strong>Sample Restriction</strong>: We restrict the sample to IPOs with an offer price ≥ $5 to exclude penny stocks and very small offerings that may exhibit extreme volatility unrelated to disclosure quality.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"../data/omnicare_rf.csv"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_raw[df_raw<span class="sc">$</span>offer_price <span class="sc">&gt;=</span> <span class="dv">5</span>, ]  <span class="co"># Restrict to offer price &gt;= $5</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create post-Omnicare indicator</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>post_omnicare <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(df<span class="sc">$</span>offer_date) <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2015-03-24"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>post_omnicare, <span class="st">"Post-Omnicare"</span>, <span class="st">"Pre-Omnicare"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Fama-French 12 Industry Classification</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: Kenneth French Data Library</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_12_ind_port.html</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>assign_ff12 <span class="ot">&lt;-</span> <span class="cf">function</span>(sic) {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Returns Fama-French 12 industry classification based on SIC code</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Returns NA if SIC is missing</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(sic)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  sic <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(sic)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Consumer NonDurables</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">100</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">999</span>) <span class="sc">|</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2000</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2399</span>) <span class="sc">|</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2700</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2749</span>) <span class="sc">|</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2770</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2799</span>) <span class="sc">|</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3100</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3199</span>) <span class="sc">|</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3940</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3989</span>)) {</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"NoDur"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Consumer Durables</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">2500</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2519</span>) <span class="sc">|</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2590</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2599</span>) <span class="sc">|</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3630</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3659</span>) <span class="sc">|</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3710</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3711</span>) <span class="sc">|</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">==</span> <span class="dv">3714</span>) <span class="sc">|</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">==</span> <span class="dv">3716</span>) <span class="sc">|</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3750</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3751</span>) <span class="sc">|</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">==</span> <span class="dv">3792</span>) <span class="sc">|</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3900</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3939</span>) <span class="sc">|</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3990</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3999</span>)) {</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Durbl"</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Manufacturing</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">2520</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2589</span>) <span class="sc">|</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2600</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2699</span>) <span class="sc">|</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2750</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2769</span>) <span class="sc">|</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3000</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3099</span>) <span class="sc">|</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3200</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3569</span>) <span class="sc">|</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3580</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3629</span>) <span class="sc">|</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3700</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3709</span>) <span class="sc">|</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3712</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3713</span>) <span class="sc">|</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">==</span> <span class="dv">3715</span>) <span class="sc">|</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3717</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3749</span>) <span class="sc">|</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3752</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3791</span>) <span class="sc">|</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3793</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3799</span>) <span class="sc">|</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3830</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3839</span>) <span class="sc">|</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3860</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3899</span>)) {</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Manuf"</span>)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Energy (Oil, Gas, Coal)</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">1200</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">1399</span>) <span class="sc">|</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2900</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2999</span>)) {</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Enrgy"</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Chemicals</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">2800</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2829</span>) <span class="sc">|</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">2840</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2899</span>)) {</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Chems"</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Business Equipment (Computers, Software, Electronics)</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">3570</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3579</span>) <span class="sc">|</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3660</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3692</span>) <span class="sc">|</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3694</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3699</span>) <span class="sc">|</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3810</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3829</span>) <span class="sc">|</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">7370</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">7379</span>)) {</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"BusEq"</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Telecommunications</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sic <span class="sc">&gt;=</span> <span class="dv">4800</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">4899</span>) {</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Telcm"</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8. Utilities</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sic <span class="sc">&gt;=</span> <span class="dv">4900</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">4949</span>) {</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Utils"</span>)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 9. Wholesale/Retail (Shops)</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">5000</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">5999</span>) <span class="sc">|</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">7200</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">7299</span>) <span class="sc">|</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">7600</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">7699</span>)) {</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Shops"</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 10. Healthcare (Medical Equipment, Drugs)</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((sic <span class="sc">&gt;=</span> <span class="dv">2830</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">2839</span>) <span class="sc">|</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">==</span> <span class="dv">3693</span>) <span class="sc">|</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">3840</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">3859</span>) <span class="sc">|</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>      (sic <span class="sc">&gt;=</span> <span class="dv">8000</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">8099</span>)) {</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Hlth"</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 11. Finance</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sic <span class="sc">&gt;=</span> <span class="dv">6000</span> <span class="sc">&amp;</span> sic <span class="sc">&lt;=</span> <span class="dv">6999</span>) {</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Money"</span>)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 12. Other</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="st">"Other"</span>)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply FF12 classification</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>ff12 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(df<span class="sc">$</span>sic_code, assign_ff12)</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>ff12 <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>ff12, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NoDur"</span>, <span class="st">"Durbl"</span>, <span class="st">"Manuf"</span>, <span class="st">"Enrgy"</span>, <span class="st">"Chems"</span>,</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"BusEq"</span>, <span class="st">"Telcm"</span>, <span class="st">"Utils"</span>, <span class="st">"Shops"</span>, <span class="st">"Hlth"</span>,</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Money"</span>, <span class="st">"Other"</span>))</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-transform size variables (adding small constant to avoid log(0))</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>log_assets <span class="ot">&lt;-</span> <span class="fu">log</span>(df<span class="sc">$</span>assets_thous <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>log_proceeds <span class="ot">&lt;-</span> <span class="fu">log</span>(df<span class="sc">$</span>total_proceeds_thous <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample sizes</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample restriction: offer_price &gt;= $5</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample restriction: offer_price &gt;= $5</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Original sample:"</span>, <span class="fu">nrow</span>(df_raw), <span class="st">"| Restricted sample:"</span>, <span class="fu">nrow</span>(df), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Original sample: 2425 | Restricted sample: 2229 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Full sample:"</span>, <span class="fu">nrow</span>(df), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Full sample: 2229 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Pre-Omnicare:"</span>, <span class="fu">sum</span>(<span class="sc">!</span>df<span class="sc">$</span>post_omnicare), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-Omnicare: 882 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Post-Omnicare:"</span>, <span class="fu">sum</span>(df<span class="sc">$</span>post_omnicare), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Post-Omnicare: 1347 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Fama-French 12 Industry Distribution ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Fama-French 12 Industry Distribution ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(df<span class="sc">$</span>ff12, <span class="at">useNA =</span> <span class="st">"ifany"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
NoDur Durbl Manuf Enrgy Chems BusEq Telcm Utils Shops  Hlth Money Other  &lt;NA&gt; 
   58    34    75    81    33   405    14    44   150   739   345   241    10 </code></pre>
</div>
</div>
<hr>
</section>
<section id="linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="linear-regression">1. Linear Regression</h2>
<p>We estimate: <span class="math display">\[\text{FirstDayReturn}_i = \alpha + \beta \cdot \text{rf\_fact\_t07}_i + \varepsilon_i\]</span></p>
<p>A negative <span class="math inline">\(\beta\)</span> would support the hypothesis that higher fact-intensity is associated with lower underpricing.</p>
<section id="full-sample" class="level3">
<h3 class="anchored" data-anchor-id="full-sample">Full Sample</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model_full <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07, <span class="at">data =</span> df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = first_day_return ~ rf_fact_t07, data = df)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.9291 -0.2129 -0.1085  0.0804  6.6647 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.50831    0.08827   5.759 9.64e-09 ***
rf_fact_t07 -0.61732    0.17206  -3.588 0.000341 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4785 on 2227 degrees of freedom
Multiple R-squared:  0.005747,  Adjusted R-squared:  0.005301 
F-statistic: 12.87 on 1 and 2227 DF,  p-value: 0.0003406</code></pre>
</div>
</div>
</section>
<section id="pre-omnicare" class="level3">
<h3 class="anchored" data-anchor-id="pre-omnicare">Pre-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model_pre <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07, <span class="at">data =</span> df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_pre)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = first_day_return ~ rf_fact_t07, data = df[!df$post_omnicare, 
    ])

Residuals:
     Min       1Q   Median       3Q      Max 
-0.57075 -0.14810 -0.06533  0.07733  1.92959 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.51875    0.07288   7.118 2.27e-12 ***
rf_fact_t07 -0.73060    0.13725  -5.323 1.30e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2506 on 880 degrees of freedom
Multiple R-squared:  0.03119,   Adjusted R-squared:  0.03009 
F-statistic: 28.33 on 1 and 880 DF,  p-value: 1.296e-07</code></pre>
</div>
</div>
</section>
<section id="post-omnicare" class="level3">
<h3 class="anchored" data-anchor-id="post-omnicare">Post-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_post <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07, <span class="at">data =</span> df[df<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = first_day_return ~ rf_fact_t07, data = df[df$post_omnicare, 
    ])

Residuals:
    Min      1Q  Median      3Q     Max 
-0.9640 -0.2525 -0.1295  0.0946  6.6518 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)  
(Intercept)   0.3312     0.1460   2.268   0.0235 *
rf_fact_t07  -0.1969     0.2915  -0.675   0.4995  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5787 on 1345 degrees of freedom
Multiple R-squared:  0.0003391, Adjusted R-squared:  -0.0004041 
F-statistic: 0.4563 on 1 and 1345 DF,  p-value: 0.4995</code></pre>
</div>
</div>
</section>
<section id="summary-table" class="level3">
<h3 class="anchored" data-anchor-id="summary-table">Summary Table</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ols_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sample =</span> <span class="fu">c</span>(<span class="st">"Full Sample"</span>, <span class="st">"Pre-Omnicare"</span>, <span class="st">"Post-Omnicare"</span>),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(df), <span class="fu">sum</span>(<span class="sc">!</span>df<span class="sc">$</span>post_omnicare), <span class="fu">sum</span>(df<span class="sc">$</span>post_omnicare)),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Coefficient =</span> <span class="fu">c</span>(<span class="fu">coef</span>(model_full)[<span class="dv">2</span>], <span class="fu">coef</span>(model_pre)[<span class="dv">2</span>], <span class="fu">coef</span>(model_post)[<span class="dv">2</span>]),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Std_Error =</span> <span class="fu">c</span>(<span class="fu">summary</span>(model_full)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summary</span>(model_pre)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summary</span>(model_post)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>]),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_stat =</span> <span class="fu">c</span>(<span class="fu">summary</span>(model_full)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">summary</span>(model_pre)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">summary</span>(model_post)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">3</span>]),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_value =</span> <span class="fu">c</span>(<span class="fu">summary</span>(model_full)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>],</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summary</span>(model_pre)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>],</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summary</span>(model_post)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>]),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_squared =</span> <span class="fu">c</span>(<span class="fu">summary</span>(model_full)<span class="sc">$</span>r.squared,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summary</span>(model_pre)<span class="sc">$</span>r.squared,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summary</span>(model_post)<span class="sc">$</span>r.squared)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ols_results, <span class="at">digits =</span> <span class="dv">4</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"N"</span>, <span class="st">"Coefficient"</span>, <span class="st">"Std. Error"</span>, <span class="st">"t-stat"</span>, <span class="st">"p-value"</span>, <span class="st">"R²"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 21%">
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Sample</th>
<th style="text-align: right;">N</th>
<th style="text-align: right;">Coefficient</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">t-stat</th>
<th style="text-align: right;">p-value</th>
<th style="text-align: right;">R²</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Full Sample</td>
<td style="text-align: right;">2229</td>
<td style="text-align: right;">-0.6173</td>
<td style="text-align: right;">0.1721</td>
<td style="text-align: right;">-3.5879</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0057</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pre-Omnicare</td>
<td style="text-align: right;">882</td>
<td style="text-align: right;">-0.7306</td>
<td style="text-align: right;">0.1373</td>
<td style="text-align: right;">-5.3230</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0312</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Post-Omnicare</td>
<td style="text-align: right;">1347</td>
<td style="text-align: right;">-0.1969</td>
<td style="text-align: right;">0.2915</td>
<td style="text-align: right;">-0.6755</td>
<td style="text-align: right;">0.4995</td>
<td style="text-align: right;">0.0003</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="binscatter-optimal-binning" class="level2">
<h2 class="anchored" data-anchor-id="binscatter-optimal-binning">2. Binscatter (Optimal Binning)</h2>
<p>Binscatter provides a non-parametric visualization of the conditional expectation function.</p>
<p><strong>Note on Implementation</strong>: For IMSE-optimal binning, install the <a href="https://nppackages.github.io/binsreg/"><code>binsreg</code></a> package from Cattaneo, Crump, Farrell, and Feng (2024). The implementation below uses a simplified quantile-based approach with the number of bins set via the rule-of-thumb <span class="math inline">\(J \approx \lceil n^{1/3} \rceil\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if binsreg is available; if not, use quantile-based fallback</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>use_binsreg <span class="ot">&lt;-</span> <span class="fu">requireNamespace</span>(<span class="st">"binsreg"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_binsreg) {</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using binsreg package for IMSE-optimal binning</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"binsreg not available; using quantile-based binning (ROT: n^(1/3) bins)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Using binsreg package for IMSE-optimal binning</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Binscatter function with binsreg or fallback</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>binscatter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, x_var, y_var, <span class="at">n_bins =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="st">""</span>) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data[[x_var]]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data[[y_var]]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove missing values</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  complete <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(x, y)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x[complete]</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[complete]</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If binsreg available, use it</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (use_binsreg) {</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(binsreg)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">binsreg</span>(y, x, <span class="at">line =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">cb =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">plot =</span> result<span class="sc">$</span>bins_plot, <span class="at">binsreg_output =</span> result))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: Rule-of-thumb number of bins (Cattaneo et al. suggest n^(1/3))</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(n_bins)) {</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    n_bins <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create quantile-based bins</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n_bins <span class="sc">+</span> <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">unique</span>(breaks)  <span class="co"># Handle ties</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> breaks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute bin means</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  bin_means <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="at">x_mean =</span> x, <span class="at">y_mean =</span> y),</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">list</span>(<span class="at">bin =</span> bins),</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> mean,</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear fit for overlay</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create plot</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> bin_means, <span class="fu">aes</span>(<span class="at">x =</span> x_mean, <span class="at">y =</span> y_mean),</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">coef</span>(fit)[<span class="dv">1</span>], <span class="at">slope =</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>],</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"darkred"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> title,</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"N = "</span>, n, <span class="st">" | Bins = "</span>, <span class="fu">length</span>(<span class="fu">unique</span>(bins)),</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>                        <span class="st">" (ROT: n^1/3) | Slope = "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit)[<span class="dv">2</span>], <span class="dv">4</span>)),</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"First-Day Return"</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray40"</span>)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">plot =</span> p, <span class="at">bin_data =</span> bin_means, <span class="at">fit =</span> fit))</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-sample-1" class="level3">
<h3 class="anchored" data-anchor-id="full-sample-1">Full Sample</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>bs_full <span class="ot">&lt;-</span> <span class="fu">binscatter</span>(df, <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">title =</span> <span class="st">"Full Sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Note: Setting at least nsims=2000 and simsgrid=50 is recommended to obtain the final results."</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-full-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Full Sample)</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bs_full<span class="sc">$</span>plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-full-2.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Full Sample)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="pre-omnicare-1" class="level3">
<h3 class="anchored" data-anchor-id="pre-omnicare-1">Pre-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bs_pre <span class="ot">&lt;-</span> <span class="fu">binscatter</span>(df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, ], <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">title =</span> <span class="st">"Pre-Omnicare (before March 24, 2015)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Note: Setting at least nsims=2000 and simsgrid=50 is recommended to obtain the final results."</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-pre-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Pre-Omnicare)</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bs_pre<span class="sc">$</span>plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-pre-2.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Pre-Omnicare)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="post-omnicare-1" class="level3">
<h3 class="anchored" data-anchor-id="post-omnicare-1">Post-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>bs_post <span class="ot">&lt;-</span> <span class="fu">binscatter</span>(df[df<span class="sc">$</span>post_omnicare, ], <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">title =</span> <span class="st">"Post-Omnicare (March 24, 2015 and after)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Note: Setting at least nsims=2000 and simsgrid=50 is recommended to obtain the final results."</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-post-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Post-Omnicare)</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bs_post<span class="sc">$</span>plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-post-2.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter: Fact-Intensity vs First-Day Return (Post-Omnicare)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="combined-panel" class="level3">
<h3 class="anchored" data-anchor-id="combined-panel">Combined Panel</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binned data for both periods (using ROT: n^(1/3) bins)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>create_bin_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data<span class="sc">$</span>rf_fact_t07</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data<span class="sc">$</span>first_day_return</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  n_bins <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">length</span>(x)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))  <span class="co"># ROT from Cattaneo et al.</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n_bins <span class="sc">+</span> <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">unique</span>(breaks)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> breaks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  bin_means <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="at">x_mean =</span> x, <span class="at">y_mean =</span> y),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">list</span>(<span class="at">bin =</span> bins),</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bin_means)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>bin_pre <span class="ot">&lt;-</span> <span class="fu">create_bin_data</span>(df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>bin_pre<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Pre-Omnicare"</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>bin_post <span class="ot">&lt;-</span> <span class="fu">create_bin_data</span>(df[df<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>bin_post<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Post-Omnicare"</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>bin_combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bin_pre, bin_post)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bin_combined, <span class="fu">aes</span>(<span class="at">x =</span> x_mean, <span class="at">y =</span> y_mean, <span class="at">color =</span> period)) <span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Binscatter: Fact-Intensity vs First-Day Return by Period"</span>,</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"First-Day Return"</span>,</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-combined-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter by Period</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="distribution-regression" class="level2">
<h2 class="anchored" data-anchor-id="distribution-regression">3. Distribution Regression</h2>
<p>Distribution regression estimates the effect of fact-intensity on the probability of exceeding various return thresholds. This provides a more complete picture of how fact-intensity shifts the entire distribution of returns, not just the mean.</p>
<p>For each threshold <span class="math inline">\(\tau\)</span>, we estimate a logistic regression: <span class="math display">\[P(\text{FirstDayReturn}_i &gt; \tau) = \Lambda(\alpha_\tau + \beta_\tau \cdot \text{rf\_fact\_t07}_i)\]</span></p>
<p>where <span class="math inline">\(\Lambda(\cdot)\)</span> is the logistic CDF. We report <strong>marginal effects</strong> evaluated at the sample mean: <span class="math display">\[\frac{\partial P(Y &gt; \tau | X = \bar{x})}{\partial x} = \beta_\tau \cdot \Lambda(\alpha_\tau + \beta_\tau \bar{x}) \cdot (1 - \Lambda(\alpha_\tau + \beta_\tau \bar{x}))\]</span></p>
<p>If higher fact-intensity reduces returns, we expect negative marginal effects (lower probability of exceeding any given threshold).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution regression: series of binary regressions with marginal effects</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>distribution_regression <span class="ot">&lt;-</span> <span class="cf">function</span>(data, x_var, y_var,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">thresholds =</span> <span class="cn">NULL</span>, <span class="at">n_thresholds =</span> <span class="dv">20</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n_bootstrap =</span> <span class="dv">200</span>) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data[[x_var]]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data[[y_var]]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove missing values</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  complete <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(x, y)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x[complete]</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[complete]</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Evaluation point: sample mean of x</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  x_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Default thresholds: quantiles of y</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(thresholds)) {</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">&lt;-</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">length.out =</span> n_thresholds), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">&lt;-</span> <span class="fu">unique</span>(thresholds)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fu">numeric</span>(),</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficient =</span> <span class="fu">numeric</span>(),</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">marginal_effect =</span> <span class="fu">numeric</span>(),</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">me_lower =</span> <span class="fu">numeric</span>(),</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">me_upper =</span> <span class="fu">numeric</span>(),</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_above =</span> <span class="fu">numeric</span>()</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tau <span class="cf">in</span> thresholds) {</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary outcome: 1 if y &gt; tau</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    y_binary <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(y <span class="sc">&gt;</span> tau)</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if all same value</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(y_binary)) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="cf">next</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logistic regression</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_binary <span class="sc">~</span> x, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(coefs)) <span class="sc">||</span> <span class="fu">length</span>(coefs) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="cf">next</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marginal effect at sample mean: β * λ(Xβ) * (1 - λ(Xβ))</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    linear_pred <span class="ot">&lt;-</span> coefs[<span class="dv">1</span>] <span class="sc">+</span> coefs[<span class="dv">2</span>] <span class="sc">*</span> x_mean</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    lambda_val <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linear_pred)</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>    marginal_effect <span class="ot">&lt;-</span> coefs[<span class="dv">2</span>] <span class="sc">*</span> lambda_val <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> lambda_val)</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap for confidence intervals</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>    boot_me <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_bootstrap)</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_bootstrap) {</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Weighted bootstrap (exponential weights)</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>      weights <span class="ot">&lt;-</span> <span class="fu">rexp</span>(n, <span class="at">rate =</span> <span class="dv">1</span>)</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>        boot_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_binary <span class="sc">~</span> x, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">weights =</span> weights)</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>        boot_coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(boot_fit)</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(boot_coefs)) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(boot_coefs) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>          boot_lp <span class="ot">&lt;-</span> boot_coefs[<span class="dv">1</span>] <span class="sc">+</span> boot_coefs[<span class="dv">2</span>] <span class="sc">*</span> x_mean</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>          boot_lambda <span class="ot">&lt;-</span> <span class="fu">plogis</span>(boot_lp)</span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>          boot_me[b] <span class="ot">&lt;-</span> boot_coefs[<span class="dv">2</span>] <span class="sc">*</span> boot_lambda <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> boot_lambda)</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>          boot_me[b] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>        boot_me[b] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate bootstrap CI</span></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>    boot_me_clean <span class="ot">&lt;-</span> boot_me[<span class="sc">!</span><span class="fu">is.na</span>(boot_me)]</span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(boot_me_clean) <span class="sc">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>      me_lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_me_clean, <span class="fl">0.025</span>)</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>      me_upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_me_clean, <span class="fl">0.975</span>)</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>      me_lower <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>      me_upper <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">threshold =</span> tau,</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">coefficient =</span> coefs[<span class="dv">2</span>],</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">marginal_effect =</span> marginal_effect,</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">me_lower =</span> me_lower,</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">me_upper =</span> me_upper,</span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">prop_above =</span> <span class="fu">mean</span>(y_binary, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="full-sample-2" class="level3">
<h3 class="anchored" data-anchor-id="full-sample-2">Full Sample</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dr_full <span class="ot">&lt;-</span> <span class="fu">distribution_regression</span>(df, <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>, <span class="at">n_thresholds =</span> <span class="dv">25</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_full, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect)) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Marginal Effects of Fact-Intensity"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Full Sample | Change in P(Return &gt; threshold) per unit increase in rf_fact, evaluated at sample mean"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-full-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression Marginal Effects (Full Sample)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="pre-omnicare-2" class="level3">
<h3 class="anchored" data-anchor-id="pre-omnicare-2">Pre-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dr_pre <span class="ot">&lt;-</span> <span class="fu">distribution_regression</span>(df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, ], <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">n_thresholds =</span> <span class="dv">20</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_pre, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect)) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"coral"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"coral"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Pre-Omnicare"</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Before March 24, 2015 | Marginal effects evaluated at sample mean"</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-pre-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression Marginal Effects (Pre-Omnicare)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="post-omnicare-2" class="level3">
<h3 class="anchored" data-anchor-id="post-omnicare-2">Post-Omnicare</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dr_post <span class="ot">&lt;-</span> <span class="fu">distribution_regression</span>(df[df<span class="sc">$</span>post_omnicare, ], <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n_thresholds =</span> <span class="dv">25</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_post, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect)) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Post-Omnicare"</span>,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"March 24, 2015 and after | Marginal effects evaluated at sample mean"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-post-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression Marginal Effects (Post-Omnicare)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="combined-comparison" class="level3">
<h3 class="anchored" data-anchor-id="combined-comparison">Combined Comparison</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>dr_pre<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Pre-Omnicare"</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>dr_post<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Post-Omnicare"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>dr_combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dr_pre, dr_post)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_combined, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect, <span class="at">color =</span> period, <span class="at">fill =</span> period)) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Pre vs Post-Omnicare"</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Marginal effects with bootstrap 95% CIs"</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span>,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span>,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Period"</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-combined-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression Marginal Effects by Period</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="summary-and-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="summary-and-interpretation">4. Summary and Interpretation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== LINEAR REGRESSION SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== LINEAR REGRESSION SUMMARY ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ols_results)) {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  sign <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ols_results<span class="sc">$</span>Coefficient[i] <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"NEGATIVE"</span>, <span class="st">"POSITIVE"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  sig <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ols_results<span class="sc">$</span>p_value[i] <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"(significant at 5%)"</span>, <span class="st">"(not significant at 5%)"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%s: beta = %.4f %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>              ols_results<span class="sc">$</span>Sample[i], ols_results<span class="sc">$</span>Coefficient[i], sig))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Full Sample: beta = -0.6173 (significant at 5%)
Pre-Omnicare: beta = -0.7306 (significant at 5%)
Post-Omnicare: beta = -0.1969 (not significant at 5%)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== INTERPRETATION ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== INTERPRETATION ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if hypothesis is supported</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>full_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_full)[<span class="dv">2</span>]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (full_coef <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The hypothesis is SUPPORTED in the full sample:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Higher fact-intensity is associated with LOWER first-day returns.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"A one-unit increase in rf_fact_t07 is associated with a %.1f percentage point</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">abs</span>(full_coef) <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"decrease in first-day returns.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The hypothesis is NOT SUPPORTED in the full sample:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Higher fact-intensity is associated with HIGHER first-day returns.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"This is contrary to the information asymmetry hypothesis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The hypothesis is SUPPORTED in the full sample:
Higher fact-intensity is associated with LOWER first-day returns.
A one-unit increase in rf_fact_t07 is associated with a 61.7 percentage point
decrease in first-day returns.</code></pre>
</div>
</div>
<hr>
</section>
<section id="technical-notes" class="level2">
<h2 class="anchored" data-anchor-id="technical-notes">Technical Notes</h2>
<section id="binscatter-method" class="level3">
<h3 class="anchored" data-anchor-id="binscatter-method">Binscatter Method</h3>
<p>The binscatter implementation uses quantile-based binning with the rule-of-thumb (ROT) number of bins <span class="math inline">\(J \approx \lceil n^{1/3} \rceil\)</span>. For proper IMSE-optimal binning with data-driven bin selection, confidence bands, and polynomial smoothing, install the <a href="https://nppackages.github.io/binsreg/"><code>binsreg</code></a> package:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"binsreg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reference: Cattaneo, M. D., Crump, R. K., Farrell, M. H., &amp; Feng, Y. (2024). “On Binscatter.” <em>American Economic Review</em>, 114(5), 1488-1514.</p>
</section>
<section id="distribution-regression-1" class="level3">
<h3 class="anchored" data-anchor-id="distribution-regression-1">Distribution Regression</h3>
<p>Distribution regression estimates the conditional distribution function at various thresholds, providing insight into heterogeneous effects across the return distribution. We use logit link functions (logistic regression) at each threshold.</p>
<p>We report <strong>marginal effects</strong> rather than raw logit coefficients. The marginal effect is: <span class="math display">\[\frac{\partial P(Y &gt; \tau | X = \bar{x})}{\partial x} = \beta \cdot \Lambda(\alpha + \beta \bar{x}) \cdot (1 - \Lambda(\alpha + \beta \bar{x}))\]</span></p>
<p>evaluated at the sample mean of rf_fact_t07. This gives the actual change in probability (not log-odds) for a one-unit increase in fact-intensity. Bootstrap confidence intervals (200 replications) are computed using weighted bootstrap with exponential weights.</p>
<p>Reference: Chernozhukov, V., Fernández-Val, I., &amp; Melly, B. (2013). “Inference on Counterfactual Distributions.” <em>Econometrica</em>, 81(6), 2205-2268.</p>
<hr>
</section>
</section>
<section id="covariate-controlled-analysis" class="level2">
<h2 class="anchored" data-anchor-id="covariate-controlled-analysis">5. Covariate-Controlled Analysis</h2>
<p>This section augments the baseline analysis by controlling for observable firm characteristics:</p>
<ul>
<li><strong>Log Assets</strong> (<code>log_assets</code>): Natural log of total assets (in thousands)</li>
<li><strong>Log Total Proceeds</strong> (<code>log_proceeds</code>): Natural log of total IPO proceeds (in thousands)</li>
<li><strong>Industry Fixed Effects</strong> (<code>ff12</code>): Fama-French 12 industry classification based on SIC codes</li>
<li><strong>Rolling Market Return</strong> (<code>roll_vwretd</code>): Value-weighted market return in the 30 days prior to IPO</li>
</ul>
<p>These controls help isolate the relationship between fact-intensity and first-day returns from confounding factors related to firm size, deal size, industry characteristics, and market conditions.</p>
<section id="ols-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="ols-with-controls">5.1 OLS with Controls</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values in control variables</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Missing Values in Control Variables ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== Missing Values in Control Variables ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"log_assets:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>log_assets)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>log_assets: 0 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"log_proceeds:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>log_proceeds)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>log_proceeds: 0 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"roll_vwretd:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>roll_vwretd)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>roll_vwretd: 0 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ff12:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(df<span class="sc">$</span>ff12)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ff12: 10 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete cases for covariate analysis</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>df_complete <span class="ot">&lt;-</span> df[<span class="fu">complete.cases</span>(df[, <span class="fu">c</span>(<span class="st">"first_day_return"</span>, <span class="st">"rf_fact_t07"</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"log_assets"</span>, <span class="st">"log_proceeds"</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"roll_vwretd"</span>, <span class="st">"ff12"</span>)]), ]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Observations with complete covariate data:"</span>, <span class="fu">nrow</span>(df_complete), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Observations with complete covariate data: 2219 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Full sample with controls</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>model_full_ctrl <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07 <span class="sc">+</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                        roll_vwretd <span class="sc">+</span> ff12, <span class="at">data =</span> df_complete)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-Omnicare with controls</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>model_pre_ctrl <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07 <span class="sc">+</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                       roll_vwretd <span class="sc">+</span> ff12, <span class="at">data =</span> df_complete[<span class="sc">!</span>df_complete<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-Omnicare with controls</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>model_post_ctrl <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> rf_fact_t07 <span class="sc">+</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                        roll_vwretd <span class="sc">+</span> ff12, <span class="at">data =</span> df_complete[df_complete<span class="sc">$</span>post_omnicare, ])</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== FULL SAMPLE (with controls) ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== FULL SAMPLE (with controls) ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_full_ctrl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = first_day_return ~ rf_fact_t07 + log_assets + log_proceeds + 
    roll_vwretd + ff12, data = df_complete)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.9047 -0.2117 -0.0824  0.0828  6.6171 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   0.194485   0.153034   1.271  0.20391   
rf_fact_t07  -0.319882   0.190615  -1.678  0.09346 . 
log_assets   -0.017470   0.006046  -2.890  0.00390 **
log_proceeds  0.025667   0.010970   2.340  0.01938 * 
roll_vwretd   1.050996   0.345250   3.044  0.00236 **
ff12Durbl     0.282037   0.102812   2.743  0.00613 **
ff12Manuf     0.111981   0.083236   1.345  0.17865   
ff12Enrgy    -0.079899   0.083009  -0.963  0.33589   
ff12Chems    -0.060966   0.103792  -0.587  0.55700   
ff12BusEq     0.121387   0.067030   1.811  0.07029 . 
ff12Telcm     0.051814   0.141720   0.366  0.71469   
ff12Utils    -0.026643   0.096133  -0.277  0.78169   
ff12Shops     0.132812   0.073623   1.804  0.07138 . 
ff12Hlth      0.036275   0.065237   0.556  0.57824   
ff12Money     0.013211   0.067888   0.195  0.84572   
ff12Other     0.077528   0.069778   1.111  0.26666   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4752 on 2203 degrees of freedom
Multiple R-squared:  0.02911,   Adjusted R-squared:  0.0225 
F-statistic: 4.404 on 15 and 2203 DF,  p-value: 3.048e-08</code></pre>
</div>
</div>
</section>
<section id="comparison-baseline-vs.-controlled" class="level3">
<h3 class="anchored" data-anchor-id="comparison-baseline-vs.-controlled">Comparison: Baseline vs.&nbsp;Controlled</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract rf_fact_t07 coefficients</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>extract_rf_coef <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"rf_fact_t07"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(coefs)) {</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">coef =</span> coefs[<span class="st">"rf_fact_t07"</span>, <span class="dv">1</span>],</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">se =</span> coefs[<span class="st">"rf_fact_t07"</span>, <span class="dv">2</span>],</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">t =</span> coefs[<span class="st">"rf_fact_t07"</span>, <span class="dv">3</span>],</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">p =</span> coefs[<span class="st">"rf_fact_t07"</span>, <span class="dv">4</span>]))</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">coef =</span> <span class="cn">NA</span>, <span class="at">se =</span> <span class="cn">NA</span>, <span class="at">t =</span> <span class="cn">NA</span>, <span class="at">p =</span> <span class="cn">NA</span>))</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sample =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Full Sample"</span>, <span class="st">"Pre-Omnicare"</span>, <span class="st">"Post-Omnicare"</span>), <span class="dv">2</span>),</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Specification =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Baseline"</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"With Controls"</span>, <span class="dv">3</span>)),</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Coefficient =</span> <span class="fu">c</span>(</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model_full)[<span class="dv">2</span>], <span class="fu">coef</span>(model_pre)[<span class="dv">2</span>], <span class="fu">coef</span>(model_post)[<span class="dv">2</span>],</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_full_ctrl)[<span class="st">"coef"</span>],</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_pre_ctrl)[<span class="st">"coef"</span>],</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_post_ctrl)[<span class="st">"coef"</span>]</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">Std_Error =</span> <span class="fu">c</span>(</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_full)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_pre)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_post)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>],</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_full_ctrl)[<span class="st">"se"</span>],</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_pre_ctrl)[<span class="st">"se"</span>],</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_post_ctrl)[<span class="st">"se"</span>]</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_value =</span> <span class="fu">c</span>(</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_full)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>],</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_pre)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>],</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(model_post)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>],</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_full_ctrl)[<span class="st">"p"</span>],</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_pre_ctrl)[<span class="st">"p"</span>],</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_rf_coef</span>(model_post_ctrl)[<span class="st">"p"</span>]</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(comparison, <span class="at">digits =</span> <span class="dv">4</span>,</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">"Effect of Fact-Intensity on First-Day Returns: Baseline vs. Controlled"</span>,</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>             <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Sample"</span>, <span class="st">"Specification"</span>, <span class="st">"Coefficient"</span>, <span class="st">"Std. Error"</span>, <span class="st">"p-value"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Effect of Fact-Intensity on First-Day Returns: Baseline vs.&nbsp;Controlled</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Sample</th>
<th style="text-align: left;">Specification</th>
<th style="text-align: right;">Coefficient</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Full Sample</td>
<td style="text-align: left;">Baseline</td>
<td style="text-align: right;">-0.6173</td>
<td style="text-align: right;">0.1721</td>
<td style="text-align: right;">0.0003</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pre-Omnicare</td>
<td style="text-align: left;">Baseline</td>
<td style="text-align: right;">-0.7306</td>
<td style="text-align: right;">0.1373</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Post-Omnicare</td>
<td style="text-align: left;">Baseline</td>
<td style="text-align: right;">-0.1969</td>
<td style="text-align: right;">0.2915</td>
<td style="text-align: right;">0.4995</td>
</tr>
<tr class="even">
<td style="text-align: left;">Full Sample</td>
<td style="text-align: left;">With Controls</td>
<td style="text-align: right;">-0.3199</td>
<td style="text-align: right;">0.1906</td>
<td style="text-align: right;">0.0935</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pre-Omnicare</td>
<td style="text-align: left;">With Controls</td>
<td style="text-align: right;">-0.3857</td>
<td style="text-align: right;">0.1531</td>
<td style="text-align: right;">0.0120</td>
</tr>
<tr class="even">
<td style="text-align: left;">Post-Omnicare</td>
<td style="text-align: left;">With Controls</td>
<td style="text-align: right;">-0.1074</td>
<td style="text-align: right;">0.3147</td>
<td style="text-align: right;">0.7330</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="control-variable-effects" class="level3">
<h3 class="anchored" data-anchor-id="control-variable-effects">Control Variable Effects</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== CONTROL VARIABLE COEFFICIENTS (Full Sample) ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== CONTROL VARIABLE COEFFICIENTS (Full Sample) ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>coef_table <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_full_ctrl)<span class="sc">$</span>coefficients</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(coef_table, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)    0.1945     0.1530  1.2709   0.2039
rf_fact_t07   -0.3199     0.1906 -1.6782   0.0935
log_assets    -0.0175     0.0060 -2.8895   0.0039
log_proceeds   0.0257     0.0110  2.3399   0.0194
roll_vwretd    1.0510     0.3453  3.0442   0.0024
ff12Durbl      0.2820     0.1028  2.7432   0.0061
ff12Manuf      0.1120     0.0832  1.3453   0.1787
ff12Enrgy     -0.0799     0.0830 -0.9625   0.3359
ff12Chems     -0.0610     0.1038 -0.5874   0.5570
ff12BusEq      0.1214     0.0670  1.8109   0.0703
ff12Telcm      0.0518     0.1417  0.3656   0.7147
ff12Utils     -0.0266     0.0961 -0.2771   0.7817
ff12Shops      0.1328     0.0736  1.8040   0.0714
ff12Hlth       0.0363     0.0652  0.5560   0.5782
ff12Money      0.0132     0.0679  0.1946   0.8457
ff12Other      0.0775     0.0698  1.1111   0.2667</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== INTERPRETATION OF CONTROLS ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== INTERPRETATION OF CONTROLS ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">log_assets: Larger firms by assets tend to have"</span>,</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">coef</span>(model_full_ctrl)[<span class="st">"log_assets"</span>] <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"LOWER"</span>, <span class="st">"HIGHER"</span>),</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first-day returns</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
log_assets: Larger firms by assets tend to have LOWER first-day returns</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"log_proceeds: Larger deals tend to have"</span>,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">coef</span>(model_full_ctrl)[<span class="st">"log_proceeds"</span>] <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"LOWER"</span>, <span class="st">"HIGHER"</span>),</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first-day returns</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>log_proceeds: Larger deals tend to have HIGHER first-day returns</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"roll_vwretd: Hot markets (higher prior returns) are associated with"</span>,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">coef</span>(model_full_ctrl)[<span class="st">"roll_vwretd"</span>] <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"LOWER"</span>, <span class="st">"HIGHER"</span>),</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first-day returns</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>roll_vwretd: Hot markets (higher prior returns) are associated with HIGHER first-day returns</code></pre>
</div>
</div>
</section>
<section id="binscatter-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="binscatter-with-controls">5.2 Binscatter with Controls</h3>
<p>To visualize the partial relationship between fact-intensity and first-day returns after controlling for covariates, we use the Frisch-Waugh-Lovell approach. The <code>binsreg</code> package handles this automatically via the <code>w</code> parameter for covariates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare control matrix for binsreg (excluding the factor, which we'll handle)</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>W_matrix <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> df_complete)[, <span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Remove intercept</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_binsreg) {</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use binsreg with covariates</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(binsreg)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  bs_ctrl_result <span class="ot">&lt;-</span> <span class="fu">binsreg</span>(</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_complete<span class="sc">$</span>first_day_return,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> df_complete<span class="sc">$</span>rf_fact_t07,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> W_matrix,</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">line =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ci =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(bs_ctrl_result<span class="sc">$</span>bins_plot <span class="sc">+</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Binscatter with Controls (Full Sample)"</span>,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">subtitle =</span> <span class="st">"IMSE-optimal binning | Controlling for log(assets), log(proceeds), roll_vwretd, FF12"</span>,</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">x =</span> <span class="st">"Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="st">"First-Day Return (residualized)"</span>))</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: Manual FWL residualization</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>  resid_y_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> df_complete)</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>  resid_x_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(rf_fact_t07 <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> df_complete)</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  df_complete<span class="sc">$</span>resid_y <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_y_model)</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>  df_complete<span class="sc">$</span>resid_x <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_x_model)</span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Binscatter on residualized data</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> df_complete<span class="sc">$</span>resid_x</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> df_complete<span class="sc">$</span>resid_y</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>  n_bins <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n_bins <span class="sc">+</span> <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>  breaks <span class="ot">&lt;-</span> <span class="fu">unique</span>(breaks)</span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>  bins <span class="ot">&lt;-</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> breaks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>  bin_means <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="at">x_mean =</span> x, <span class="at">y_mean =</span> y),</span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">list</span>(<span class="at">bin =</span> bins),</span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> bin_means, <span class="fu">aes</span>(<span class="at">x =</span> x_mean, <span class="at">y =</span> y_mean),</span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">coef</span>(fit)[<span class="dv">1</span>], <span class="at">slope =</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>],</span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Binscatter with Controls (Full Sample)"</span>,</span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"N = "</span>, n, <span class="st">" | Bins = "</span>, <span class="fu">length</span>(<span class="fu">unique</span>(bins)),</span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>                        <span class="st">" | Slope = "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit)[<span class="dv">2</span>], <span class="dv">4</span>),</span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>                        <span class="st">" | FWL residualization"</span>),</span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Residualized Fact-Intensity"</span>,</span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Residualized First-Day Return"</span></span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray40"</span>)</span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-controls-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter with Controls (Full Sample)</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-controls-2.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter with Controls (Full Sample)</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">OLS coefficient on rf_fact_t07 (with controls):"</span>,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">coef</span>(model_full_ctrl)[<span class="st">"rf_fact_t07"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
OLS coefficient on rf_fact_t07 (with controls): -0.3199 </code></pre>
</div>
</div>
</section>
<section id="binscatter-by-period-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="binscatter-by-period-with-controls">Binscatter by Period (with Controls)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data by period</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>df_pre <span class="ot">&lt;-</span> df_complete[<span class="sc">!</span>df_complete<span class="sc">$</span>post_omnicare, ]</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>df_post <span class="ot">&lt;-</span> df_complete[df_complete<span class="sc">$</span>post_omnicare, ]</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (use_binsreg) {</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use binsreg with covariates for each period</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(binsreg)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control matrices for each period</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  W_pre <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> df_pre)[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  W_post <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> df_post)[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pre-Omnicare</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>  bs_pre_ctrl <span class="ot">&lt;-</span> <span class="fu">binsreg</span>(</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_pre<span class="sc">$</span>first_day_return,</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> df_pre<span class="sc">$</span>rf_fact_t07,</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> W_pre,</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">line =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Post-Omnicare</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>  bs_post_ctrl <span class="ot">&lt;-</span> <span class="fu">binsreg</span>(</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> df_post<span class="sc">$</span>first_day_return,</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> df_post<span class="sc">$</span>rf_fact_t07,</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> W_post,</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">line =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract bin data and combine</span></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>  pre_data <span class="ot">&lt;-</span> bs_pre_ctrl<span class="sc">$</span>data.plot<span class="sc">$</span><span class="st">`</span><span class="at">Group Full Sample</span><span class="st">`</span><span class="sc">$</span>data.dots</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>  pre_data<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Pre-Omnicare"</span></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>  post_data <span class="ot">&lt;-</span> bs_post_ctrl<span class="sc">$</span>data.plot<span class="sc">$</span><span class="st">`</span><span class="at">Group Full Sample</span><span class="st">`</span><span class="sc">$</span>data.dots</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>  post_data<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Post-Omnicare"</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>  combined_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pre_data, post_data)</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get slopes from OLS with controls</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>  slope_pre <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_pre_ctrl)[<span class="st">"rf_fact_t07"</span>]</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>  slope_post <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_post_ctrl)[<span class="st">"rf_fact_t07"</span>]</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(combined_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> fit, <span class="at">color =</span> period)) <span class="sc">+</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Binscatter with Controls: Pre vs. Post-Omnicare"</span>,</span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"OLS slopes (with controls): Pre = %.4f | Post = %.4f"</span>, slope_pre, slope_post),</span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"First-Day Return (residualized)"</span>,</span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Period"</span></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: Manual FWL residualization</span></span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a>  resid_y_pre <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> df_pre)</span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a>  resid_x_pre <span class="ot">&lt;-</span> <span class="fu">lm</span>(rf_fact_t07 <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> df_pre)</span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a>  df_pre<span class="sc">$</span>resid_y <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_y_pre)</span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a>  df_pre<span class="sc">$</span>resid_x <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_x_pre)</span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a>  resid_y_post <span class="ot">&lt;-</span> <span class="fu">lm</span>(first_day_return <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-69"><a href="#cb82-69" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> df_post)</span>
<span id="cb82-70"><a href="#cb82-70" aria-hidden="true" tabindex="-1"></a>  resid_x_post <span class="ot">&lt;-</span> <span class="fu">lm</span>(rf_fact_t07 <span class="sc">~</span> log_assets <span class="sc">+</span> log_proceeds <span class="sc">+</span> roll_vwretd <span class="sc">+</span> ff12,</span>
<span id="cb82-71"><a href="#cb82-71" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> df_post)</span>
<span id="cb82-72"><a href="#cb82-72" aria-hidden="true" tabindex="-1"></a>  df_post<span class="sc">$</span>resid_y <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_y_post)</span>
<span id="cb82-73"><a href="#cb82-73" aria-hidden="true" tabindex="-1"></a>  df_post<span class="sc">$</span>resid_x <span class="ot">&lt;-</span> <span class="fu">residuals</span>(resid_x_post)</span>
<span id="cb82-74"><a href="#cb82-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-75"><a href="#cb82-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create binned data for both periods</span></span>
<span id="cb82-76"><a href="#cb82-76" aria-hidden="true" tabindex="-1"></a>  create_resid_bins <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb82-77"><a href="#cb82-77" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> data<span class="sc">$</span>resid_x</span>
<span id="cb82-78"><a href="#cb82-78" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> data<span class="sc">$</span>resid_y</span>
<span id="cb82-79"><a href="#cb82-79" aria-hidden="true" tabindex="-1"></a>    n_bins <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">length</span>(x)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb82-80"><a href="#cb82-80" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n_bins <span class="sc">+</span> <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb82-81"><a href="#cb82-81" aria-hidden="true" tabindex="-1"></a>    breaks <span class="ot">&lt;-</span> <span class="fu">unique</span>(breaks)</span>
<span id="cb82-82"><a href="#cb82-82" aria-hidden="true" tabindex="-1"></a>    bins <span class="ot">&lt;-</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> breaks, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb82-83"><a href="#cb82-83" aria-hidden="true" tabindex="-1"></a>    bin_means <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb82-84"><a href="#cb82-84" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(<span class="at">x_mean =</span> x, <span class="at">y_mean =</span> y),</span>
<span id="cb82-85"><a href="#cb82-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">list</span>(<span class="at">bin =</span> bins),</span>
<span id="cb82-86"><a href="#cb82-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb82-87"><a href="#cb82-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-88"><a href="#cb82-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(bin_means)</span>
<span id="cb82-89"><a href="#cb82-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-90"><a href="#cb82-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-91"><a href="#cb82-91" aria-hidden="true" tabindex="-1"></a>  bin_pre_ctrl <span class="ot">&lt;-</span> <span class="fu">create_resid_bins</span>(df_pre)</span>
<span id="cb82-92"><a href="#cb82-92" aria-hidden="true" tabindex="-1"></a>  bin_pre_ctrl<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Pre-Omnicare"</span></span>
<span id="cb82-93"><a href="#cb82-93" aria-hidden="true" tabindex="-1"></a>  bin_post_ctrl <span class="ot">&lt;-</span> <span class="fu">create_resid_bins</span>(df_post)</span>
<span id="cb82-94"><a href="#cb82-94" aria-hidden="true" tabindex="-1"></a>  bin_post_ctrl<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Post-Omnicare"</span></span>
<span id="cb82-95"><a href="#cb82-95" aria-hidden="true" tabindex="-1"></a>  bin_combined_ctrl <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bin_pre_ctrl, bin_post_ctrl)</span>
<span id="cb82-96"><a href="#cb82-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-97"><a href="#cb82-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get slopes for annotation</span></span>
<span id="cb82-98"><a href="#cb82-98" aria-hidden="true" tabindex="-1"></a>  slope_pre <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(resid_y <span class="sc">~</span> resid_x, <span class="at">data =</span> df_pre))[<span class="dv">2</span>]</span>
<span id="cb82-99"><a href="#cb82-99" aria-hidden="true" tabindex="-1"></a>  slope_post <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(resid_y <span class="sc">~</span> resid_x, <span class="at">data =</span> df_post))[<span class="dv">2</span>]</span>
<span id="cb82-100"><a href="#cb82-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-101"><a href="#cb82-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(bin_combined_ctrl, <span class="fu">aes</span>(<span class="at">x =</span> x_mean, <span class="at">y =</span> y_mean, <span class="at">color =</span> period)) <span class="sc">+</span></span>
<span id="cb82-102"><a href="#cb82-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb82-103"><a href="#cb82-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb82-104"><a href="#cb82-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb82-105"><a href="#cb82-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb82-106"><a href="#cb82-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Binscatter with Controls: Pre vs. Post-Omnicare"</span>,</span>
<span id="cb82-107"><a href="#cb82-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"Slopes: Pre = %.4f | Post = %.4f"</span>, slope_pre, slope_post),</span>
<span id="cb82-108"><a href="#cb82-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Residualized Fact-Intensity"</span>,</span>
<span id="cb82-109"><a href="#cb82-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Residualized First-Day Return"</span>,</span>
<span id="cb82-110"><a href="#cb82-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Period"</span></span>
<span id="cb82-111"><a href="#cb82-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb82-112"><a href="#cb82-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb82-113"><a href="#cb82-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb82-114"><a href="#cb82-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb82-115"><a href="#cb82-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb82-116"><a href="#cb82-116" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-117"><a href="#cb82-117" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-controls-periods-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter with Controls by Period</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-controls-periods-2.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter with Controls by Period</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/binscatter-controls-periods-3.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Binscatter with Controls by Period</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="distribution-regression-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="distribution-regression-with-controls">5.3 Distribution Regression with Controls</h3>
<p>We extend the distribution regression to include covariates. For each threshold <span class="math inline">\(\tau\)</span>, we estimate:</p>
<p><span class="math display">\[P(\text{FirstDayReturn}_i &gt; \tau) = \Lambda(\alpha_\tau + \beta_\tau \cdot \text{rf\_fact\_t07}_i + \gamma_\tau' \mathbf{X}_i)\]</span></p>
<p>where <span class="math inline">\(\mathbf{X}_i\)</span> includes log assets, log proceeds, rolling market return, and industry fixed effects.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution regression with controls</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>distribution_regression_controls <span class="ot">&lt;-</span> <span class="cf">function</span>(data, x_var, y_var, controls,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">thresholds =</span> <span class="cn">NULL</span>, <span class="at">n_thresholds =</span> <span class="dv">20</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">n_bootstrap =</span> <span class="dv">200</span>) {</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build formula</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  formula_str <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"y_binary ~"</span>, x_var, <span class="st">"+"</span>, <span class="fu">paste</span>(controls, <span class="at">collapse =</span> <span class="st">" + "</span>))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data[[y_var]]</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data[[x_var]]</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove missing values</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  vars_needed <span class="ot">&lt;-</span> <span class="fu">c</span>(y_var, x_var, controls)</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  complete_idx <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(data[, vars_needed])</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  data_clean <span class="ot">&lt;-</span> data[complete_idx, ]</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data_clean[[y_var]]</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> data_clean[[x_var]]</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_clean)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Evaluation point: sample means</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  x_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Default thresholds: quantiles of y</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(thresholds)) {</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">&lt;-</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">length.out =</span> n_thresholds), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">&lt;-</span> <span class="fu">unique</span>(thresholds)</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fu">numeric</span>(),</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficient =</span> <span class="fu">numeric</span>(),</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">marginal_effect =</span> <span class="fu">numeric</span>(),</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">me_lower =</span> <span class="fu">numeric</span>(),</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">me_upper =</span> <span class="fu">numeric</span>(),</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_above =</span> <span class="fu">numeric</span>()</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tau <span class="cf">in</span> thresholds) {</span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary outcome: 1 if y &gt; tau</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>    data_clean<span class="sc">$</span>y_binary <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(data_clean[[y_var]] <span class="sc">&gt;</span> tau)</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip if all same value</span></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(data_clean<span class="sc">$</span>y_binary)) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="cf">next</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logistic regression with controls</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> data_clean,</span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>      coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)</span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(coefs)) <span class="sc">||</span> <span class="sc">!</span>(x_var <span class="sc">%in%</span> <span class="fu">names</span>(coefs))) <span class="cf">next</span></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Marginal effect at sample mean for rf_fact_t07</span></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Need to compute linear predictor at mean values</span></span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>      newdata_mean <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">lapply</span>(data_clean[, vars_needed[<span class="sc">-</span><span class="dv">1</span>], <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>                                         <span class="cf">function</span>(col) {</span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>                                           <span class="cf">if</span> (<span class="fu">is.numeric</span>(col)) <span class="fu">mean</span>(col, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>                                           <span class="cf">else</span> <span class="fu">names</span>(<span class="fu">which.max</span>(<span class="fu">table</span>(col)))</span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>                                         }))</span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># For factor variables, use the reference level prediction</span></span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>      linear_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> newdata_mean, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>      lambda_val <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linear_pred)</span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>      beta_rf <span class="ot">&lt;-</span> coefs[x_var]</span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>      marginal_effect <span class="ot">&lt;-</span> beta_rf <span class="sc">*</span> lambda_val <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> lambda_val)</span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Bootstrap for confidence intervals</span></span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>      boot_me <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_bootstrap)</span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_bootstrap) {</span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>        weights <span class="ot">&lt;-</span> <span class="fu">rexp</span>(n, <span class="at">rate =</span> <span class="dv">1</span>)</span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>          boot_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> data_clean,</span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">weights =</span> weights)</span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a>          boot_coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(boot_fit)</span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(boot_coefs)) <span class="sc">&amp;&amp;</span> x_var <span class="sc">%in%</span> <span class="fu">names</span>(boot_coefs)) {</span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a>            boot_lp <span class="ot">&lt;-</span> <span class="fu">predict</span>(boot_fit, <span class="at">newdata =</span> newdata_mean, <span class="at">type =</span> <span class="st">"link"</span>)</span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a>            boot_lambda <span class="ot">&lt;-</span> <span class="fu">plogis</span>(boot_lp)</span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a>            boot_me[b] <span class="ot">&lt;-</span> boot_coefs[x_var] <span class="sc">*</span> boot_lambda <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> boot_lambda)</span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a>            boot_me[b] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a>          boot_me[b] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate bootstrap CI</span></span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a>      boot_me_clean <span class="ot">&lt;-</span> boot_me[<span class="sc">!</span><span class="fu">is.na</span>(boot_me)]</span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(boot_me_clean) <span class="sc">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a>        me_lower <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_me_clean, <span class="fl">0.025</span>)</span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a>        me_upper <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_me_clean, <span class="fl">0.975</span>)</span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb84-94"><a href="#cb84-94" aria-hidden="true" tabindex="-1"></a>        me_lower <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-95"><a href="#cb84-95" aria-hidden="true" tabindex="-1"></a>        me_upper <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-96"><a href="#cb84-96" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb84-97"><a href="#cb84-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-98"><a href="#cb84-98" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb84-99"><a href="#cb84-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">threshold =</span> tau,</span>
<span id="cb84-100"><a href="#cb84-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefficient =</span> beta_rf,</span>
<span id="cb84-101"><a href="#cb84-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">marginal_effect =</span> marginal_effect,</span>
<span id="cb84-102"><a href="#cb84-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">me_lower =</span> me_lower,</span>
<span id="cb84-103"><a href="#cb84-103" aria-hidden="true" tabindex="-1"></a>        <span class="at">me_upper =</span> me_upper,</span>
<span id="cb84-104"><a href="#cb84-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">prop_above =</span> <span class="fu">mean</span>(data_clean<span class="sc">$</span>y_binary, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-105"><a href="#cb84-105" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb84-106"><a href="#cb84-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-107"><a href="#cb84-107" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb84-108"><a href="#cb84-108" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Skip this threshold on error</span></span>
<span id="cb84-109"><a href="#cb84-109" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb84-110"><a href="#cb84-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-111"><a href="#cb84-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-112"><a href="#cb84-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb84-113"><a href="#cb84-113" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="full-sample-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="full-sample-with-controls">Full Sample with Controls</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define control variables (excluding ff12 which is a factor - handle separately)</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For simplicity, we'll use the numeric controls and ff12 as factor</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>controls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_assets"</span>, <span class="st">"log_proceeds"</span>, <span class="st">"roll_vwretd"</span>, <span class="st">"ff12"</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>dr_full_ctrl <span class="ot">&lt;-</span> <span class="fu">distribution_regression_controls</span>(</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  df_complete, <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  controls, <span class="at">n_thresholds =</span> <span class="dv">25</span>, <span class="at">n_bootstrap =</span> <span class="dv">200</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_full_ctrl, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect)) <span class="sc">+</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper),</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression with Controls: Full Sample"</span>,</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Controlling for log(assets), log(proceeds), roll_vwretd, and FF12 industry FE"</span>,</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-full-controls-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression with Controls (Full Sample)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-baseline-vs.-controlled-distribution-regression" class="level3">
<h3 class="anchored" data-anchor-id="comparison-baseline-vs.-controlled-distribution-regression">Comparison: Baseline vs.&nbsp;Controlled Distribution Regression</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>dr_full<span class="sc">$</span>specification <span class="ot">&lt;-</span> <span class="st">"Baseline"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>dr_full_ctrl<span class="sc">$</span>specification <span class="ot">&lt;-</span> <span class="st">"With Controls"</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>dr_compare <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  dr_full[, <span class="fu">c</span>(<span class="st">"threshold"</span>, <span class="st">"marginal_effect"</span>, <span class="st">"me_lower"</span>, <span class="st">"me_upper"</span>, <span class="st">"specification"</span>)],</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  dr_full_ctrl[, <span class="fu">c</span>(<span class="st">"threshold"</span>, <span class="st">"marginal_effect"</span>, <span class="st">"me_lower"</span>, <span class="st">"me_upper"</span>, <span class="st">"specification"</span>)]</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_compare, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect,</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> specification, <span class="at">fill =</span> specification)) <span class="sc">+</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper), <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"With Controls"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>)) <span class="sc">+</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"With Controls"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>)) <span class="sc">+</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Effect of Adding Controls"</span>,</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Full sample | Marginal effect of rf_fact_t07 on P(Return &gt; threshold)"</span>,</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span>,</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Specification"</span>,</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Specification"</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-comparison-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression: Baseline vs.&nbsp;With Controls</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="pre-vs.-post-omnicare-with-controls" class="level3">
<h3 class="anchored" data-anchor-id="pre-vs.-post-omnicare-with-controls">Pre vs.&nbsp;Post-Omnicare with Controls</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>dr_pre_ctrl <span class="ot">&lt;-</span> <span class="fu">distribution_regression_controls</span>(</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  df_complete[<span class="sc">!</span>df_complete<span class="sc">$</span>post_omnicare, ],</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  controls, <span class="at">n_thresholds =</span> <span class="dv">20</span>, <span class="at">n_bootstrap =</span> <span class="dv">200</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>dr_post_ctrl <span class="ot">&lt;-</span> <span class="fu">distribution_regression_controls</span>(</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  df_complete[df_complete<span class="sc">$</span>post_omnicare, ],</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"rf_fact_t07"</span>, <span class="st">"first_day_return"</span>,</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  controls, <span class="at">n_thresholds =</span> <span class="dv">25</span>, <span class="at">n_bootstrap =</span> <span class="dv">200</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>dr_pre_ctrl<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Pre-Omnicare"</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>dr_post_ctrl<span class="sc">$</span>period <span class="ot">&lt;-</span> <span class="st">"Post-Omnicare"</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>dr_periods_ctrl <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dr_pre_ctrl, dr_post_ctrl)</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dr_periods_ctrl, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> marginal_effect,</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">color =</span> period, <span class="at">fill =</span> period)) <span class="sc">+</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> me_lower, <span class="at">ymax =</span> me_upper), <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution Regression: Pre vs. Post-Omnicare (With Controls)"</span>,</span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Controlling for log(assets), log(proceeds), roll_vwretd, and FF12 industry FE"</span>,</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Marginal Effect ∂P/∂rf_fact"</span>,</span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span>,</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Period"</span></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/dist-reg-periods-controls-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Distribution Regression by Period (With Controls)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="summary-of-covariate-analysis" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-covariate-analysis">5.4 Summary of Covariate Analysis</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== COVARIATE-CONTROLLED ANALYSIS SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== COVARIATE-CONTROLLED ANALYSIS SUMMARY ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Controls included:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Controls included:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - log(assets_thous): Firm size proxy</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - log(assets_thous): Firm size proxy</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - log(total_proceeds_thous): Deal size</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - log(total_proceeds_thous): Deal size</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - roll_vwretd: Market conditions (30-day rolling VW return)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - roll_vwretd: Market conditions (30-day rolling VW return)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - ff12: Fama-French 12 industry fixed effects</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - ff12: Fama-French 12 industry fixed effects</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample sizes:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample sizes:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Full sample (complete cases):"</span>, <span class="fu">nrow</span>(df_complete), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Full sample (complete cases): 2219 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Pre-Omnicare:"</span>, <span class="fu">sum</span>(<span class="sc">!</span>df_complete<span class="sc">$</span>post_omnicare), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Pre-Omnicare: 874 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Post-Omnicare:"</span>, <span class="fu">sum</span>(df_complete<span class="sc">$</span>post_omnicare), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Post-Omnicare: 1345 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Key findings:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Key findings:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>baseline_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_full)[<span class="dv">2</span>]</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>controlled_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_full_ctrl)[<span class="st">"rf_fact_t07"</span>]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - Baseline rf_fact_t07 coefficient: %.4f</span><span class="sc">\n</span><span class="st">"</span>, baseline_coef))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Baseline rf_fact_t07 coefficient: -0.6173</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - Controlled rf_fact_t07 coefficient: %.4f</span><span class="sc">\n</span><span class="st">"</span>, controlled_coef))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Controlled rf_fact_t07 coefficient: -0.3199</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - Change: %.4f (%.1f%%)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>            controlled_coef <span class="sc">-</span> baseline_coef,</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span> <span class="sc">*</span> (controlled_coef <span class="sc">-</span> baseline_coef) <span class="sc">/</span> <span class="fu">abs</span>(baseline_coef)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Change: 0.2974 (48.2%)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">sign</span>(baseline_coef) <span class="sc">==</span> <span class="fu">sign</span>(controlled_coef)) {</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">The sign of the rf_fact_t07 effect is ROBUST to the inclusion of controls.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">WARNING: The sign of the rf_fact_t07 effect CHANGES with the inclusion of controls.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
The sign of the rf_fact_t07 effect is ROBUST to the inclusion of controls.</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="cfm-distributional-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="cfm-distributional-decomposition">6. CFM Distributional Decomposition</h2>
<p>This section implements the counterfactual decomposition from <a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/ECTA10582">Chernozhukov, Fernandez-Val, and Melly (2013)</a>. We decompose the change in the distribution of first-day returns between pre- and post-Omnicare periods into:</p>
<ol type="1">
<li><strong>Structure Effect</strong>: Changes due to differences in how the market prices IPOs for a given level of fact-intensity (the “wage structure” in CFM terminology)</li>
<li><strong>Composition Effect</strong>: Changes due to differences in the distribution of fact-intensity itself</li>
</ol>
<section id="notation-and-setup" class="level3">
<h3 class="anchored" data-anchor-id="notation-and-setup">Notation and Setup</h3>
<p>Let <span class="math inline">\(Y_j\)</span> denote first-day returns and <span class="math inline">\(X_j\)</span> denote fact-intensity for period <span class="math inline">\(j \in \{0, 1\}\)</span> (pre/post Omnicare).</p>
<ul>
<li><span class="math inline">\(F_{Y\langle 0|0 \rangle}\)</span>: Observed pre-Omnicare return distribution</li>
<li><span class="math inline">\(F_{Y\langle 1|1 \rangle}\)</span>: Observed post-Omnicare return distribution</li>
<li><span class="math inline">\(F_{Y\langle 0|1 \rangle}\)</span>: <strong>Counterfactual</strong> - returns that would have prevailed post-Omnicare if the market still priced like pre-Omnicare</li>
</ul>
<p>The decomposition is: <span class="math display">\[F_{Y\langle 1|1 \rangle} - F_{Y\langle 0|0 \rangle} = \underbrace{\left[F_{Y\langle 1|1 \rangle} - F_{Y\langle 0|1 \rangle}\right]}_{\text{Structure Effect}} + \underbrace{\left[F_{Y\langle 0|1 \rangle} - F_{Y\langle 0|0 \rangle}\right]}_{\text{Composition Effect}}\]</span></p>
</section>
<section id="raw-distributional-shifts-pre-vs.-post-omnicare" class="level3">
<h3 class="anchored" data-anchor-id="raw-distributional-shifts-pre-vs.-post-omnicare">Raw Distributional Shifts: Pre vs.&nbsp;Post Omnicare</h3>
<p>Before running the decomposition, let’s visualize how both the covariate (rf_fact) and the outcome (first_day_return) actually shifted between periods. This helps us interpret the composition and structure effects.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>df_pre_raw <span class="ot">&lt;-</span> df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, ]</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>df_post_raw <span class="ot">&lt;-</span> df[df<span class="sc">$</span>post_omnicare, ]</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: rf_fact distribution (what drives composition effect)</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>p_rf_cdf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> df_pre_raw, <span class="fu">aes</span>(<span class="at">x =</span> rf_fact_t07, <span class="at">color =</span> <span class="st">"Pre-Omnicare"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> df_post_raw, <span class="fu">aes</span>(<span class="at">x =</span> rf_fact_t07, <span class="at">color =</span> <span class="st">"Post-Omnicare"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"A. Covariate Distribution: Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"This drives the COMPOSITION effect"</span>,</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Fact-Intensity (rf_fact_t07)"</span>,</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cumulative Probability"</span>,</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: First-day return distribution (the outcome)</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>p_return_cdf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> df_pre_raw, <span class="fu">aes</span>(<span class="at">x =</span> first_day_return, <span class="at">color =</span> <span class="st">"Pre-Omnicare"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ecdf</span>(<span class="at">data =</span> df_post_raw, <span class="fu">aes</span>(<span class="at">x =</span> first_day_return, <span class="at">color =</span> <span class="st">"Post-Omnicare"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>)) <span class="sc">+</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>)) <span class="sc">+</span>  <span class="co"># Focus on main mass</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"B. Outcome Distribution: First-Day Returns"</span>,</span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Total change = Structure + Composition"</span>,</span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return"</span>,</span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cumulative Probability"</span>,</span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>p_rf_cdf <span class="sc">/</span> p_return_cdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/raw-distribution-shifts-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Raw Distributional Shifts: Pre vs.&nbsp;Post Omnicare</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary statistics</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== DISTRIBUTIONAL SHIFT SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== DISTRIBUTIONAL SHIFT SUMMARY ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fact-Intensity (rf_fact_t07):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Fact-Intensity (rf_fact_t07):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Pre-Omnicare mean:  %.4f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Pre-Omnicare mean:  0.5274</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Post-Omnicare mean: %.4f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(df_post_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Post-Omnicare mean: 0.4980</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Difference: %.4f (%s)</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(df_post_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">mean</span>(df_post_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>rf_fact_t07, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"MORE facts post-Omnicare"</span>, <span class="st">"FEWER facts post-Omnicare"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Difference: -0.0294 (FEWER facts post-Omnicare)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"First-Day Returns:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>First-Day Returns:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Pre-Omnicare mean:  %.4f (%.1f%%)</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Pre-Omnicare mean:  0.1334 (13.3%)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Post-Omnicare mean: %.4f (%.1f%%)</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(df_post_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(df_post_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Post-Omnicare mean: 0.2332 (23.3%)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Difference: %.4f (%s)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(df_post_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">mean</span>(df_post_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> <span class="fu">mean</span>(df_pre_raw<span class="sc">$</span>first_day_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"LESS underpricing post-Omnicare"</span>, <span class="st">"MORE underpricing post-Omnicare"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Difference: 0.0997 (MORE underpricing post-Omnicare)</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate conditional distribution using logit regression</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>estimate_conditional_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(data, outcome_var, covariate, <span class="at">y_grid =</span> <span class="cn">NULL</span>) {</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(y_grid)) {</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    y_values <span class="ot">&lt;-</span> data[[outcome_var]]</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    y_grid <span class="ot">&lt;-</span> <span class="fu">quantile</span>(y_values, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.05</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>    y_grid <span class="ot">&lt;-</span> <span class="fu">unique</span>(y_grid)</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>  distribution_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>  successful_fits <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(y_grid)) {</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>    y_threshold <span class="ot">&lt;-</span> y_grid[j]</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>    temp_data <span class="ot">&lt;-</span> data</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>    temp_data<span class="sc">$</span>binary_indicator <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[outcome_var]] <span class="sc">&lt;=</span> y_threshold)</span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>    prop_below <span class="ot">&lt;-</span> <span class="fu">mean</span>(temp_data<span class="sc">$</span>binary_indicator)</span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (prop_below <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> prop_below <span class="sc">==</span> <span class="dv">1</span>) <span class="cf">next</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a>      logit_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"binary_indicator ~"</span>, covariate))</span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>      logit_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(logit_formula, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> temp_data)</span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>logit_fit<span class="sc">$</span>converged) <span class="cf">next</span></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a>      distribution_results[[<span class="fu">length</span>(distribution_results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">y_threshold =</span> y_threshold,</span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit =</span> logit_fit,</span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefficients =</span> <span class="fu">coef</span>(logit_fit)</span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a>      successful_fits <span class="ot">&lt;-</span> <span class="fu">c</span>(successful_fits, y_threshold)</span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Silent error handling</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution_results =</span> distribution_results,</span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_grid =</span> successful_fits</span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to predict conditional CDF given covariates and estimated models</span></span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a>predict_conditional_cdf <span class="ot">&lt;-</span> <span class="cf">function</span>(distribution_results, covariate_values, y_grid) {</span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a>  n_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(covariate_values)</span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a>  n_thresholds <span class="ot">&lt;-</span> <span class="fu">length</span>(y_grid)</span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a>  cdf_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_obs, <span class="at">ncol =</span> n_thresholds)</span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a>  actual_thresholds <span class="ot">&lt;-</span> <span class="fu">sapply</span>(distribution_results, <span class="cf">function</span>(x) x<span class="sc">$</span>y_threshold)</span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_thresholds) {</span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(actual_thresholds <span class="sc">-</span> y_grid[i]) <span class="sc">&lt;</span> <span class="fl">1e-10</span>)</span>
<span id="cb137-59"><a href="#cb137-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-60"><a href="#cb137-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(match_idx) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb137-61"><a href="#cb137-61" aria-hidden="true" tabindex="-1"></a>      coefs <span class="ot">&lt;-</span> distribution_results[[match_idx]]<span class="sc">$</span>coefficients</span>
<span id="cb137-62"><a href="#cb137-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(coefs) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb137-63"><a href="#cb137-63" aria-hidden="true" tabindex="-1"></a>        linear_pred <span class="ot">&lt;-</span> coefs[<span class="dv">1</span>] <span class="sc">+</span> coefs[<span class="dv">2</span>] <span class="sc">*</span> covariate_values</span>
<span id="cb137-64"><a href="#cb137-64" aria-hidden="true" tabindex="-1"></a>        cdf_matrix[, i] <span class="ot">&lt;-</span> <span class="fu">plogis</span>(linear_pred)</span>
<span id="cb137-65"><a href="#cb137-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb137-66"><a href="#cb137-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb137-67"><a href="#cb137-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-68"><a href="#cb137-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-69"><a href="#cb137-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cdf_matrix)</span>
<span id="cb137-70"><a href="#cb137-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-71"><a href="#cb137-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-72"><a href="#cb137-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate marginal CDF from conditional CDF</span></span>
<span id="cb137-73"><a href="#cb137-73" aria-hidden="true" tabindex="-1"></a>estimate_marginal_cdf <span class="ot">&lt;-</span> <span class="cf">function</span>(conditional_cdf_matrix, y_grid) {</span>
<span id="cb137-74"><a href="#cb137-74" aria-hidden="true" tabindex="-1"></a>  marginal_cdf <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(conditional_cdf_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-75"><a href="#cb137-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-76"><a href="#cb137-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb137-77"><a href="#cb137-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_threshold =</span> y_grid,</span>
<span id="cb137-78"><a href="#cb137-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">cdf_value =</span> marginal_cdf</span>
<span id="cb137-79"><a href="#cb137-79" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb137-80"><a href="#cb137-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-81"><a href="#cb137-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-82"><a href="#cb137-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Main CFM decomposition function</span></span>
<span id="cb137-83"><a href="#cb137-83" aria-hidden="true" tabindex="-1"></a>cfm_decomposition <span class="ot">&lt;-</span> <span class="cf">function</span>(data, outcome_var, covariate, group_var, <span class="at">y_grid =</span> <span class="cn">NULL</span>) {</span>
<span id="cb137-84"><a href="#cb137-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-85"><a href="#cb137-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split data by groups</span></span>
<span id="cb137-86"><a href="#cb137-86" aria-hidden="true" tabindex="-1"></a>  before_data <span class="ot">&lt;-</span> data[data[[group_var]] <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[outcome_var]]) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[covariate]]), ]</span>
<span id="cb137-87"><a href="#cb137-87" aria-hidden="true" tabindex="-1"></a>  after_data <span class="ot">&lt;-</span> data[data[[group_var]] <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[outcome_var]]) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[covariate]]), ]</span>
<span id="cb137-88"><a href="#cb137-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-89"><a href="#cb137-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create common y_grid based on combined data</span></span>
<span id="cb137-90"><a href="#cb137-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(y_grid)) {</span>
<span id="cb137-91"><a href="#cb137-91" aria-hidden="true" tabindex="-1"></a>    all_outcome_values <span class="ot">&lt;-</span> <span class="fu">c</span>(before_data[[outcome_var]], after_data[[outcome_var]])</span>
<span id="cb137-92"><a href="#cb137-92" aria-hidden="true" tabindex="-1"></a>    y_grid <span class="ot">&lt;-</span> <span class="fu">quantile</span>(all_outcome_values, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.05</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-93"><a href="#cb137-93" aria-hidden="true" tabindex="-1"></a>    y_grid <span class="ot">&lt;-</span> <span class="fu">unique</span>(y_grid)</span>
<span id="cb137-94"><a href="#cb137-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-95"><a href="#cb137-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-96"><a href="#cb137-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate conditional distributions for each period</span></span>
<span id="cb137-97"><a href="#cb137-97" aria-hidden="true" tabindex="-1"></a>  cond_dist_before <span class="ot">&lt;-</span> <span class="fu">estimate_conditional_distribution</span>(before_data, outcome_var, covariate, y_grid)</span>
<span id="cb137-98"><a href="#cb137-98" aria-hidden="true" tabindex="-1"></a>  cond_dist_after <span class="ot">&lt;-</span> <span class="fu">estimate_conditional_distribution</span>(after_data, outcome_var, covariate, y_grid)</span>
<span id="cb137-99"><a href="#cb137-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-100"><a href="#cb137-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use intersection of successful fits</span></span>
<span id="cb137-101"><a href="#cb137-101" aria-hidden="true" tabindex="-1"></a>  common_y_grid <span class="ot">&lt;-</span> <span class="fu">intersect</span>(cond_dist_before<span class="sc">$</span>y_grid, cond_dist_after<span class="sc">$</span>y_grid)</span>
<span id="cb137-102"><a href="#cb137-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-103"><a href="#cb137-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(common_y_grid) <span class="sc">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb137-104"><a href="#cb137-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"Insufficient common thresholds for decomposition. Only"</span>, <span class="fu">length</span>(common_y_grid), <span class="st">"available."</span>))</span>
<span id="cb137-105"><a href="#cb137-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-106"><a href="#cb137-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-107"><a href="#cb137-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find indices of common thresholds</span></span>
<span id="cb137-108"><a href="#cb137-108" aria-hidden="true" tabindex="-1"></a>  before_indices <span class="ot">&lt;-</span> <span class="fu">match</span>(common_y_grid, cond_dist_before<span class="sc">$</span>y_grid)</span>
<span id="cb137-109"><a href="#cb137-109" aria-hidden="true" tabindex="-1"></a>  after_indices <span class="ot">&lt;-</span> <span class="fu">match</span>(common_y_grid, cond_dist_after<span class="sc">$</span>y_grid)</span>
<span id="cb137-110"><a href="#cb137-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-111"><a href="#cb137-111" aria-hidden="true" tabindex="-1"></a>  valid_indices <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(before_indices) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(after_indices)</span>
<span id="cb137-112"><a href="#cb137-112" aria-hidden="true" tabindex="-1"></a>  common_y_grid <span class="ot">&lt;-</span> common_y_grid[valid_indices]</span>
<span id="cb137-113"><a href="#cb137-113" aria-hidden="true" tabindex="-1"></a>  before_indices <span class="ot">&lt;-</span> before_indices[valid_indices]</span>
<span id="cb137-114"><a href="#cb137-114" aria-hidden="true" tabindex="-1"></a>  after_indices <span class="ot">&lt;-</span> after_indices[valid_indices]</span>
<span id="cb137-115"><a href="#cb137-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-116"><a href="#cb137-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract results for common grid</span></span>
<span id="cb137-117"><a href="#cb137-117" aria-hidden="true" tabindex="-1"></a>  before_results <span class="ot">&lt;-</span> cond_dist_before<span class="sc">$</span>distribution_results[before_indices]</span>
<span id="cb137-118"><a href="#cb137-118" aria-hidden="true" tabindex="-1"></a>  after_results <span class="ot">&lt;-</span> cond_dist_after<span class="sc">$</span>distribution_results[after_indices]</span>
<span id="cb137-119"><a href="#cb137-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-120"><a href="#cb137-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract covariate values</span></span>
<span id="cb137-121"><a href="#cb137-121" aria-hidden="true" tabindex="-1"></a>  X_before <span class="ot">&lt;-</span> before_data[[covariate]]</span>
<span id="cb137-122"><a href="#cb137-122" aria-hidden="true" tabindex="-1"></a>  X_after <span class="ot">&lt;-</span> after_data[[covariate]]</span>
<span id="cb137-123"><a href="#cb137-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-124"><a href="#cb137-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the four distributions:</span></span>
<span id="cb137-125"><a href="#cb137-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-126"><a href="#cb137-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. F^{before|before}: Observed before distribution</span></span>
<span id="cb137-127"><a href="#cb137-127" aria-hidden="true" tabindex="-1"></a>  cdf_before_given_before <span class="ot">&lt;-</span> <span class="fu">predict_conditional_cdf</span>(before_results, X_before, common_y_grid)</span>
<span id="cb137-128"><a href="#cb137-128" aria-hidden="true" tabindex="-1"></a>  F_before_before <span class="ot">&lt;-</span> <span class="fu">estimate_marginal_cdf</span>(cdf_before_given_before, common_y_grid)</span>
<span id="cb137-129"><a href="#cb137-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-130"><a href="#cb137-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. F^{after|after}: Observed after distribution</span></span>
<span id="cb137-131"><a href="#cb137-131" aria-hidden="true" tabindex="-1"></a>  cdf_after_given_after <span class="ot">&lt;-</span> <span class="fu">predict_conditional_cdf</span>(after_results, X_after, common_y_grid)</span>
<span id="cb137-132"><a href="#cb137-132" aria-hidden="true" tabindex="-1"></a>  F_after_after <span class="ot">&lt;-</span> <span class="fu">estimate_marginal_cdf</span>(cdf_after_given_after, common_y_grid)</span>
<span id="cb137-133"><a href="#cb137-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-134"><a href="#cb137-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. F^{before|after}: Counterfactual - before structure with after composition</span></span>
<span id="cb137-135"><a href="#cb137-135" aria-hidden="true" tabindex="-1"></a>  cdf_before_given_after <span class="ot">&lt;-</span> <span class="fu">predict_conditional_cdf</span>(before_results, X_after, common_y_grid)</span>
<span id="cb137-136"><a href="#cb137-136" aria-hidden="true" tabindex="-1"></a>  F_before_after <span class="ot">&lt;-</span> <span class="fu">estimate_marginal_cdf</span>(cdf_before_given_after, common_y_grid)</span>
<span id="cb137-137"><a href="#cb137-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-138"><a href="#cb137-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. F^{after|before}: Counterfactual - after structure with before composition</span></span>
<span id="cb137-139"><a href="#cb137-139" aria-hidden="true" tabindex="-1"></a>  cdf_after_given_before <span class="ot">&lt;-</span> <span class="fu">predict_conditional_cdf</span>(after_results, X_before, common_y_grid)</span>
<span id="cb137-140"><a href="#cb137-140" aria-hidden="true" tabindex="-1"></a>  F_after_before <span class="ot">&lt;-</span> <span class="fu">estimate_marginal_cdf</span>(cdf_after_given_before, common_y_grid)</span>
<span id="cb137-141"><a href="#cb137-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-142"><a href="#cb137-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Decomposition</span></span>
<span id="cb137-143"><a href="#cb137-143" aria-hidden="true" tabindex="-1"></a>  total_change <span class="ot">&lt;-</span> F_after_after<span class="sc">$</span>cdf_value <span class="sc">-</span> F_before_before<span class="sc">$</span>cdf_value</span>
<span id="cb137-144"><a href="#cb137-144" aria-hidden="true" tabindex="-1"></a>  structure_effect <span class="ot">&lt;-</span> F_after_after<span class="sc">$</span>cdf_value <span class="sc">-</span> F_before_after<span class="sc">$</span>cdf_value</span>
<span id="cb137-145"><a href="#cb137-145" aria-hidden="true" tabindex="-1"></a>  composition_effect <span class="ot">&lt;-</span> F_before_after<span class="sc">$</span>cdf_value <span class="sc">-</span> F_before_before<span class="sc">$</span>cdf_value</span>
<span id="cb137-146"><a href="#cb137-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-147"><a href="#cb137-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alternative decomposition</span></span>
<span id="cb137-148"><a href="#cb137-148" aria-hidden="true" tabindex="-1"></a>  structure_effect_alt <span class="ot">&lt;-</span> F_after_before<span class="sc">$</span>cdf_value <span class="sc">-</span> F_before_before<span class="sc">$</span>cdf_value</span>
<span id="cb137-149"><a href="#cb137-149" aria-hidden="true" tabindex="-1"></a>  composition_effect_alt <span class="ot">&lt;-</span> F_after_after<span class="sc">$</span>cdf_value <span class="sc">-</span> F_after_before<span class="sc">$</span>cdf_value</span>
<span id="cb137-150"><a href="#cb137-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-151"><a href="#cb137-151" aria-hidden="true" tabindex="-1"></a>  decomposition_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb137-152"><a href="#cb137-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_threshold =</span> common_y_grid,</span>
<span id="cb137-153"><a href="#cb137-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">F_before_before =</span> F_before_before<span class="sc">$</span>cdf_value,</span>
<span id="cb137-154"><a href="#cb137-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">F_after_after =</span> F_after_after<span class="sc">$</span>cdf_value,</span>
<span id="cb137-155"><a href="#cb137-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">F_before_after =</span> F_before_after<span class="sc">$</span>cdf_value,</span>
<span id="cb137-156"><a href="#cb137-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">F_after_before =</span> F_after_before<span class="sc">$</span>cdf_value,</span>
<span id="cb137-157"><a href="#cb137-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_change =</span> total_change,</span>
<span id="cb137-158"><a href="#cb137-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">structure_effect =</span> structure_effect,</span>
<span id="cb137-159"><a href="#cb137-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">composition_effect =</span> composition_effect,</span>
<span id="cb137-160"><a href="#cb137-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">structure_effect_alt =</span> structure_effect_alt,</span>
<span id="cb137-161"><a href="#cb137-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">composition_effect_alt =</span> composition_effect_alt</span>
<span id="cb137-162"><a href="#cb137-162" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-163"><a href="#cb137-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-164"><a href="#cb137-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb137-165"><a href="#cb137-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">decomposition =</span> decomposition_results,</span>
<span id="cb137-166"><a href="#cb137-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_sizes =</span> <span class="fu">list</span>(<span class="at">before =</span> <span class="fu">nrow</span>(before_data), <span class="at">after =</span> <span class="fu">nrow</span>(after_data)),</span>
<span id="cb137-167"><a href="#cb137-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_grid =</span> common_y_grid</span>
<span id="cb137-168"><a href="#cb137-168" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb137-169"><a href="#cb137-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-170"><a href="#cb137-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-171"><a href="#cb137-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap function for confidence intervals</span></span>
<span id="cb137-172"><a href="#cb137-172" aria-hidden="true" tabindex="-1"></a>bootstrap_cfm_decomposition <span class="ot">&lt;-</span> <span class="cf">function</span>(data, outcome_var, covariate, group_var,</span>
<span id="cb137-173"><a href="#cb137-173" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">y_grid =</span> <span class="cn">NULL</span>, <span class="at">n_bootstrap =</span> <span class="dv">200</span>) {</span>
<span id="cb137-174"><a href="#cb137-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-175"><a href="#cb137-175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Original decomposition</span></span>
<span id="cb137-176"><a href="#cb137-176" aria-hidden="true" tabindex="-1"></a>  original_results <span class="ot">&lt;-</span> <span class="fu">cfm_decomposition</span>(data, outcome_var, covariate, group_var, y_grid)</span>
<span id="cb137-177"><a href="#cb137-177" aria-hidden="true" tabindex="-1"></a>  y_grid_common <span class="ot">&lt;-</span> original_results<span class="sc">$</span>y_grid</span>
<span id="cb137-178"><a href="#cb137-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-179"><a href="#cb137-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap</span></span>
<span id="cb137-180"><a href="#cb137-180" aria-hidden="true" tabindex="-1"></a>  bootstrap_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb137-181"><a href="#cb137-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-182"><a href="#cb137-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_bootstrap) {</span>
<span id="cb137-183"><a href="#cb137-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb137-184"><a href="#cb137-184" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Sample with replacement within each group</span></span>
<span id="cb137-185"><a href="#cb137-185" aria-hidden="true" tabindex="-1"></a>      before_data <span class="ot">&lt;-</span> data[data[[group_var]] <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[outcome_var]]) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[covariate]]), ]</span>
<span id="cb137-186"><a href="#cb137-186" aria-hidden="true" tabindex="-1"></a>      after_data <span class="ot">&lt;-</span> data[data[[group_var]] <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[outcome_var]]) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[covariate]]), ]</span>
<span id="cb137-187"><a href="#cb137-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-188"><a href="#cb137-188" aria-hidden="true" tabindex="-1"></a>      before_boot <span class="ot">&lt;-</span> before_data[<span class="fu">sample</span>(<span class="fu">nrow</span>(before_data), <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb137-189"><a href="#cb137-189" aria-hidden="true" tabindex="-1"></a>      after_boot <span class="ot">&lt;-</span> after_data[<span class="fu">sample</span>(<span class="fu">nrow</span>(after_data), <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb137-190"><a href="#cb137-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-191"><a href="#cb137-191" aria-hidden="true" tabindex="-1"></a>      boot_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before_boot, after_boot)</span>
<span id="cb137-192"><a href="#cb137-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-193"><a href="#cb137-193" aria-hidden="true" tabindex="-1"></a>      boot_results <span class="ot">&lt;-</span> <span class="fu">cfm_decomposition</span>(boot_data, outcome_var, covariate, group_var, y_grid_common)</span>
<span id="cb137-194"><a href="#cb137-194" aria-hidden="true" tabindex="-1"></a>      bootstrap_results[[b]] <span class="ot">&lt;-</span> boot_results<span class="sc">$</span>decomposition</span>
<span id="cb137-195"><a href="#cb137-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-196"><a href="#cb137-196" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb137-197"><a href="#cb137-197" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Silent error handling</span></span>
<span id="cb137-198"><a href="#cb137-198" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb137-199"><a href="#cb137-199" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-200"><a href="#cb137-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-201"><a href="#cb137-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove failed bootstrap iterations</span></span>
<span id="cb137-202"><a href="#cb137-202" aria-hidden="true" tabindex="-1"></a>  bootstrap_results <span class="ot">&lt;-</span> bootstrap_results[<span class="sc">!</span><span class="fu">sapply</span>(bootstrap_results, is.null)]</span>
<span id="cb137-203"><a href="#cb137-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-204"><a href="#cb137-204" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(bootstrap_results) <span class="sc">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb137-205"><a href="#cb137-205" aria-hidden="true" tabindex="-1"></a>    n_successful <span class="ot">&lt;-</span> <span class="fu">length</span>(bootstrap_results)</span>
<span id="cb137-206"><a href="#cb137-206" aria-hidden="true" tabindex="-1"></a>    n_thresholds <span class="ot">&lt;-</span> <span class="fu">length</span>(y_grid_common)</span>
<span id="cb137-207"><a href="#cb137-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-208"><a href="#cb137-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract bootstrap values</span></span>
<span id="cb137-209"><a href="#cb137-209" aria-hidden="true" tabindex="-1"></a>    total_change_boot <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_successful, n_thresholds)</span>
<span id="cb137-210"><a href="#cb137-210" aria-hidden="true" tabindex="-1"></a>    structure_boot <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_successful, n_thresholds)</span>
<span id="cb137-211"><a href="#cb137-211" aria-hidden="true" tabindex="-1"></a>    composition_boot <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_successful, n_thresholds)</span>
<span id="cb137-212"><a href="#cb137-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-213"><a href="#cb137-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_successful) {</span>
<span id="cb137-214"><a href="#cb137-214" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(bootstrap_results[[i]]) <span class="sc">==</span> n_thresholds) {</span>
<span id="cb137-215"><a href="#cb137-215" aria-hidden="true" tabindex="-1"></a>        total_change_boot[i, ] <span class="ot">&lt;-</span> bootstrap_results[[i]]<span class="sc">$</span>total_change</span>
<span id="cb137-216"><a href="#cb137-216" aria-hidden="true" tabindex="-1"></a>        structure_boot[i, ] <span class="ot">&lt;-</span> bootstrap_results[[i]]<span class="sc">$</span>structure_effect</span>
<span id="cb137-217"><a href="#cb137-217" aria-hidden="true" tabindex="-1"></a>        composition_boot[i, ] <span class="ot">&lt;-</span> bootstrap_results[[i]]<span class="sc">$</span>composition_effect</span>
<span id="cb137-218"><a href="#cb137-218" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb137-219"><a href="#cb137-219" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb137-220"><a href="#cb137-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-221"><a href="#cb137-221" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate confidence intervals</span></span>
<span id="cb137-222"><a href="#cb137-222" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>total_ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(total_change_boot, <span class="dv">2</span>, quantile, <span class="fl">0.025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-223"><a href="#cb137-223" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>total_ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(total_change_boot, <span class="dv">2</span>, quantile, <span class="fl">0.975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-224"><a href="#cb137-224" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>structure_ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(structure_boot, <span class="dv">2</span>, quantile, <span class="fl">0.025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-225"><a href="#cb137-225" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>structure_ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(structure_boot, <span class="dv">2</span>, quantile, <span class="fl">0.975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-226"><a href="#cb137-226" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>composition_ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(composition_boot, <span class="dv">2</span>, quantile, <span class="fl">0.025</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-227"><a href="#cb137-227" aria-hidden="true" tabindex="-1"></a>    original_results<span class="sc">$</span>decomposition<span class="sc">$</span>composition_ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(composition_boot, <span class="dv">2</span>, quantile, <span class="fl">0.975</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-228"><a href="#cb137-228" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-229"><a href="#cb137-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-230"><a href="#cb137-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(original_results)</span>
<span id="cb137-231"><a href="#cb137-231" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="run-the-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="run-the-decomposition">Run the Decomposition</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run CFM decomposition with bootstrap</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>decomp_results <span class="ot">&lt;-</span> <span class="fu">bootstrap_cfm_decomposition</span>(</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_var =</span> <span class="st">"first_day_return"</span>,</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">covariate =</span> <span class="st">"rf_fact_t07"</span>,</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_var =</span> <span class="st">"post_omnicare"</span>,</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_bootstrap =</span> <span class="dv">500</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>decomp_data <span class="ot">&lt;-</span> decomp_results<span class="sc">$</span>decomposition</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== CFM DECOMPOSITION SUMMARY ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== CFM DECOMPOSITION SUMMARY ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample sizes:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample sizes:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Pre-Omnicare:"</span>, decomp_results<span class="sc">$</span>sample_sizes<span class="sc">$</span>before, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Pre-Omnicare: 882 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Post-Omnicare:"</span>, decomp_results<span class="sc">$</span>sample_sizes<span class="sc">$</span>after, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Post-Omnicare: 1347 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of thresholds:"</span>, <span class="fu">length</span>(decomp_results<span class="sc">$</span>y_grid), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of thresholds: 19 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average effects across distribution</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average effects across the distribution:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average effects across the distribution:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Total change: %.4f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(decomp_data<span class="sc">$</span>total_change)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Total change: -0.0400</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Structure effect: %.4f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(decomp_data<span class="sc">$</span>structure_effect)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Structure effect: -0.0216</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Composition effect: %.4f</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">mean</span>(decomp_data<span class="sc">$</span>composition_effect)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Composition effect: -0.0184</code></pre>
</div>
</div>
</section>
<section id="plot-all-four-distributions" class="level3">
<h3 class="anchored" data-anchor-id="plot-all-four-distributions">Plot: All Four Distributions</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>dist_long <span class="ot">&lt;-</span> decomp_data <span class="sc">|&gt;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(y_threshold, F_before_before, F_after_after, F_before_after, F_after_before) <span class="sc">|&gt;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>y_threshold, <span class="at">names_to =</span> <span class="st">"distribution"</span>, <span class="at">values_to =</span> <span class="st">"cdf_value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_label =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>      distribution <span class="sc">==</span> <span class="st">"F_before_before"</span> <span class="sc">~</span> <span class="st">"Observed Pre-Omnicare"</span>,</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>      distribution <span class="sc">==</span> <span class="st">"F_after_after"</span> <span class="sc">~</span> <span class="st">"Observed Post-Omnicare"</span>,</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>      distribution <span class="sc">==</span> <span class="st">"F_before_after"</span> <span class="sc">~</span> <span class="st">"Pre Structure + Post Composition"</span>,</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>      distribution <span class="sc">==</span> <span class="st">"F_after_before"</span> <span class="sc">~</span> <span class="st">"Post Structure + Pre Composition"</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>      distribution <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"F_before_before"</span>, <span class="st">"F_after_after"</span>) <span class="sc">~</span> <span class="st">"Observed"</span>,</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Counterfactual"</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dist_long, <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">y =</span> cdf_value, <span class="at">color =</span> dist_label, <span class="at">linetype =</span> dist_type)) <span class="sc">+</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Observed"</span> <span class="ot">=</span> <span class="st">"solid"</span>, <span class="st">"Counterfactual"</span> <span class="ot">=</span> <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Observed Pre-Omnicare"</span> <span class="ot">=</span> <span class="st">"coral"</span>,</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Observed Post-Omnicare"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>,</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pre Structure + Post Composition"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>,</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Post Structure + Pre Composition"</span> <span class="ot">=</span> <span class="st">"purple"</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"CFM Decomposition: Observed and Counterfactual CDFs"</span>,</span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"First-day return distributions pre vs. post Omnicare"</span>,</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"First-Day Return"</span>,</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cumulative Probability F(return)"</span>,</span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Distribution"</span>,</span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"Type"</span></span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/cfm-distributions-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Observed and Counterfactual CDFs</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-decomposition-effects" class="level3">
<h3 class="anchored" data-anchor-id="plot-decomposition-effects">Plot: Decomposition Effects</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape effects for plotting</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>effect_long <span class="ot">&lt;-</span> decomp_data <span class="sc">|&gt;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(y_threshold, total_change, structure_effect, composition_effect) <span class="sc">|&gt;</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>y_threshold, <span class="at">names_to =</span> <span class="st">"effect_type"</span>, <span class="at">values_to =</span> <span class="st">"effect_value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect_label =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>      effect_type <span class="sc">==</span> <span class="st">"total_change"</span> <span class="sc">~</span> <span class="st">"Total Change"</span>,</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>      effect_type <span class="sc">==</span> <span class="st">"structure_effect"</span> <span class="sc">~</span> <span class="st">"Structure Effect (Pricing)"</span>,</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>      effect_type <span class="sc">==</span> <span class="st">"composition_effect"</span> <span class="sc">~</span> <span class="st">"Composition Effect (rf_fact distribution)"</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if we have confidence intervals</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>has_ci <span class="ot">&lt;-</span> <span class="st">"total_ci_lower"</span> <span class="sc">%in%</span> <span class="fu">names</span>(decomp_data)</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (has_ci) {</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confidence ribbons</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data =</span> decomp_data,</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">ymin =</span> total_ci_lower, <span class="at">ymax =</span> total_ci_upper),</span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data =</span> decomp_data,</span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">ymin =</span> structure_ci_lower, <span class="at">ymax =</span> structure_ci_upper),</span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data =</span> decomp_data,</span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">ymin =</span> composition_ci_lower, <span class="at">ymax =</span> composition_ci_upper),</span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Effect lines</span></span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> effect_long,</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">y =</span> effect_value, <span class="at">color =</span> effect_label),</span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Total Change"</span> <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Structure Effect (Pricing)"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Composition Effect (rf_fact distribution)"</span> <span class="ot">=</span> <span class="st">"blue"</span></span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"CFM Decomposition: Structure vs. Composition Effects"</span>,</span>
<span id="cb157-40"><a href="#cb157-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Total change = Structure effect + Composition effect"</span>,</span>
<span id="cb157-41"><a href="#cb157-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb157-42"><a href="#cb157-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Change in Cumulative Probability"</span>,</span>
<span id="cb157-43"><a href="#cb157-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Effect Type"</span>,</span>
<span id="cb157-44"><a href="#cb157-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Shaded areas: 95% bootstrap confidence intervals"</span></span>
<span id="cb157-45"><a href="#cb157-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-46"><a href="#cb157-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb157-47"><a href="#cb157-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb157-48"><a href="#cb157-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb157-49"><a href="#cb157-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb157-50"><a href="#cb157-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb157-51"><a href="#cb157-51" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb157-52"><a href="#cb157-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(effect_long, <span class="fu">aes</span>(<span class="at">x =</span> y_threshold, <span class="at">y =</span> effect_value, <span class="at">color =</span> effect_label)) <span class="sc">+</span></span>
<span id="cb157-53"><a href="#cb157-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb157-54"><a href="#cb157-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb157-55"><a href="#cb157-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb157-56"><a href="#cb157-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Total Change"</span> <span class="ot">=</span> <span class="st">"black"</span>,</span>
<span id="cb157-57"><a href="#cb157-57" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Structure Effect (Pricing)"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb157-58"><a href="#cb157-58" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Composition Effect (rf_fact distribution)"</span> <span class="ot">=</span> <span class="st">"blue"</span></span>
<span id="cb157-59"><a href="#cb157-59" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb157-60"><a href="#cb157-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb157-61"><a href="#cb157-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"CFM Decomposition: Structure vs. Composition Effects"</span>,</span>
<span id="cb157-62"><a href="#cb157-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Total change = Structure effect + Composition effect"</span>,</span>
<span id="cb157-63"><a href="#cb157-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"First-Day Return Threshold"</span>,</span>
<span id="cb157-64"><a href="#cb157-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Change in Cumulative Probability"</span>,</span>
<span id="cb157-65"><a href="#cb157-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Effect Type"</span></span>
<span id="cb157-66"><a href="#cb157-66" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb157-67"><a href="#cb157-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb157-68"><a href="#cb157-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb157-69"><a href="#cb157-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb157-70"><a href="#cb157-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb157-71"><a href="#cb157-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb157-72"><a href="#cb157-72" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02_measure_validation_files/figure-html/cfm-effects-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>CFM Decomposition: Structure vs.&nbsp;Composition Effects</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="interpretation" class="level3">
<h3 class="anchored" data-anchor-id="interpretation">Interpretation</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== INTERPRETATION ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== INTERPRETATION ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>avg_total <span class="ot">&lt;-</span> <span class="fu">mean</span>(decomp_data<span class="sc">$</span>total_change)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>avg_structure <span class="ot">&lt;-</span> <span class="fu">mean</span>(decomp_data<span class="sc">$</span>structure_effect)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>avg_composition <span class="ot">&lt;-</span> <span class="fu">mean</span>(decomp_data<span class="sc">$</span>composition_effect)</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (avg_total <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"TOTAL CHANGE: Post-Omnicare has MORE mass at lower returns (less underpricing overall).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"TOTAL CHANGE: Post-Omnicare has LESS mass at lower returns (more underpricing overall).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>TOTAL CHANGE: Post-Omnicare has LESS mass at lower returns (more underpricing overall).</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">DECOMPOSITION:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
DECOMPOSITION:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Structure effect interpretation</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (avg_structure <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"- STRUCTURE EFFECT ("</span>, <span class="fu">round</span>(avg_structure, <span class="dv">4</span>), <span class="st">"): The market PRICES IPOs differently post-Omnicare.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  For the same level of fact-intensity, post-Omnicare IPOs have LESS underpricing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  This suggests the market reacted to Omnicare by requiring less 'money on the table.'</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"- STRUCTURE EFFECT ("</span>, <span class="fu">round</span>(avg_structure, <span class="dv">4</span>), <span class="st">"): The market PRICES IPOs differently post-Omnicare.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  For the same level of fact-intensity, post-Omnicare IPOs have MORE underpricing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>- STRUCTURE EFFECT ( -0.0216 ): The market PRICES IPOs differently post-Omnicare.
  For the same level of fact-intensity, post-Omnicare IPOs have MORE underpricing.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Composition effect interpretation - use actual data to determine direction</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>rf_pre_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[<span class="sc">!</span>df<span class="sc">$</span>post_omnicare, <span class="st">"rf_fact_t07"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>rf_post_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[df<span class="sc">$</span>post_omnicare, <span class="st">"rf_fact_t07"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>rf_shift_direction <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(rf_post_mean <span class="sc">&gt;</span> rf_pre_mean, <span class="st">"increased (more facts)"</span>, <span class="st">"decreased (fewer facts)"</span>)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (avg_composition <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">- COMPOSITION EFFECT ("</span>, <span class="fu">round</span>(avg_composition, <span class="dv">4</span>), <span class="st">"): The distribution of rf_fact SHIFTED post-Omnicare.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Given the same pricing structure, changes in fact-intensity would have led to LESS underpricing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">- COMPOSITION EFFECT ("</span>, <span class="fu">round</span>(avg_composition, <span class="dv">4</span>), <span class="st">"): The distribution of rf_fact SHIFTED post-Omnicare.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Given the same pricing structure, changes in fact-intensity would have led to MORE underpricing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
- COMPOSITION EFFECT ( -0.0184 ): The distribution of rf_fact SHIFTED post-Omnicare.
  Given the same pricing structure, changes in fact-intensity would have led to MORE underpricing.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Fact: rf_fact %s post-Omnicare (pre mean: %.4f, post mean: %.4f)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>            rf_shift_direction, rf_pre_mean, rf_post_mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Fact: rf_fact decreased (fewer facts) post-Omnicare (pre mean: 0.5274, post mean: 0.4980)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relative contributions</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>total_abs <span class="ot">&lt;-</span> <span class="fu">abs</span>(avg_structure) <span class="sc">+</span> <span class="fu">abs</span>(avg_composition)</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (total_abs <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">RELATIVE CONTRIBUTIONS:</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Structure effect: %.1f%% of total absolute change</span><span class="sc">\n</span><span class="st">"</span>, <span class="dv">100</span> <span class="sc">*</span> <span class="fu">abs</span>(avg_structure) <span class="sc">/</span> total_abs))</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Composition effect: %.1f%% of total absolute change</span><span class="sc">\n</span><span class="st">"</span>, <span class="dv">100</span> <span class="sc">*</span> <span class="fu">abs</span>(avg_composition) <span class="sc">/</span> total_abs))</span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
RELATIVE CONTRIBUTIONS:
  Structure effect: 53.9% of total absolute change
  Composition effect: 46.1% of total absolute change</code></pre>
</div>
</div>
</section>
<section id="technical-notes-on-cfm-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="technical-notes-on-cfm-decomposition">Technical Notes on CFM Decomposition</h3>
<p>The decomposition follows Chernozhukov, Fernandez-Val, and Melly (2013, <em>Econometrica</em>).</p>
<p><strong>Key insight</strong>: The total change in the distribution can be attributed to two sources:</p>
<ol type="1">
<li><p><strong>Structure Effect</strong> (<span class="math inline">\(F_{Y\langle 1|1 \rangle} - F_{Y\langle 0|1 \rangle}\)</span>): How the conditional distribution <span class="math inline">\(F_{Y|X}\)</span> changed. This captures changes in how the market translates fact-intensity into returns.</p></li>
<li><p><strong>Composition Effect</strong> (<span class="math inline">\(F_{Y\langle 0|1 \rangle} - F_{Y\langle 0|0 \rangle}\)</span>): How the distribution of <span class="math inline">\(X\)</span> (fact-intensity) changed. This captures changes in firm disclosure behavior.</p></li>
</ol>
<p><strong>Estimation</strong>: We estimate <span class="math inline">\(F_{Y|X}(y|x)\)</span> via logistic regressions at each threshold <span class="math inline">\(y\)</span>: <span class="math display">\[P(Y \leq y | X = x) = \Lambda(\alpha_y + \beta_y x)\]</span></p>
<p>The counterfactual <span class="math inline">\(F_{Y\langle 0|1 \rangle}\)</span> is constructed by applying the pre-Omnicare conditional distribution to the post-Omnicare covariate distribution: <span class="math display">\[F_{Y\langle 0|1 \rangle}(y) = \frac{1}{n_1} \sum_{i: \text{post}} F_{Y|X}^{\text{pre}}(y | X_i)\]</span></p>
<p>Reference: Chernozhukov, V., Fernández-Val, I., &amp; Melly, B. (2013). “Inference on Counterfactual Distributions.” <em>Econometrica</em>, 81(6), 2205-2268.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>